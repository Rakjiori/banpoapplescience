<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="layout :: layout(~{::body})">
<body>
<style>
    .shop-hero {
        background: linear-gradient(135deg,#0f172a,#3b4b8f,#60a5fa);
        color:#fff;
        border-radius:20px;
        padding:20px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:14px;
        box-shadow:0 16px 36px rgba(0,0,0,0.16);
    }
    .shop-grid {
        display:grid;
        grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
        gap:12px;
    }
    .shop-card { padding:14px; border:1px solid #e5e7eb; border-radius:14px; background:#fff; box-shadow:0 8px 20px rgba(0,0,0,0.04); }
    .item-list { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; max-width:360px; }
    .badge-tile { padding:10px; border-radius:12px; border:1px solid #e5e7eb; background:#f8fafc; display:flex; flex-direction:column; gap:6px; }
    .locked { opacity:0.5; }
    .boost-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px; }
    .item-list .active { border:1px solid #ef4444 !important; box-shadow:0 0 0 1px rgba(239,68,68,0.2); }
    @media(max-width:768px){ .shop-hero{flex-direction:column;} }
</style>
<div>
    <div class="shop-hero">
        <div>
            <div style="font-size:20px; font-weight:800;">상점</div>
            <div style="color:#e2e8f0; font-size:13px;">아바타·배너·뱃지·부스트를 모아 나만의 학습 공간을 꾸며보세요.</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <div class="pill-soft" style="background:rgba(255,255,255,0.14); color:#fff;">포인트: <span th:text="${user.points}">0</span>P</div>
            <div class="pill-soft" style="background:rgba(255,255,255,0.14); color:#fff;">연속 풀이: <span th:text="${user.streak}">0</span>일</div>
            <div class="pill-soft" style="background:rgba(255,255,255,0.14); color:#fff;">보유 쉴드: <span th:text="${user.shieldItems}">0</span></div>
            <div class="pill-soft" style="background:rgba(255,255,255,0.14); color:#fff;">추가 토큰: <span th:text="${user.extraProblemTokens}">0</span></div>
        </div>
    </div>

    <div style="margin:14px 0; display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn btn-outline" href="/profile">프로필로 돌아가기</a>
        <a class="btn btn-outline" href="/stats">통계 보기</a>
    </div>

    <div class="shop-grid">
        <div class="shop-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div style="font-weight:700;">아바타</div>
            </div>
            <form th:action="@{/shop/avatar}" method="post" id="avatarForm">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <div class="item-list">
                    <label th:each="opt,iter : ${avatarOptions}"
                           class="btn btn-outline"
                           th:classappend="${ownedAvatars.contains(opt.value())} ? ' owned' : ''"
                           style="display:flex; flex-direction:column; align-items:flex-start; gap:4px; padding:12px; font-size:18px; cursor:pointer;">
                        <input type="radio" name="avatar" th:id="|avatar_${iter.index}|" th:value="${opt.value()}" style="position:absolute; opacity:0; pointer-events:none;">
                        <div th:text="${opt.value()}"></div>
                        <div style="font-size:12px;">
                            <span th:text="${opt.label()}">이름</span> ·
                            <span th:text="${ownedAvatars.contains(opt.value()) ? '보유' : opt.cost() + 'P'}">가격</span>
                        </div>
                    </label>
                </div>
                <div style="margin-top:10px; display:flex; justify-content:flex-end;">
                    <button class="btn" type="submit">구매 / 적용</button>
                </div>
            </form>
        </div>

        <div class="shop-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div style="font-weight:700;">배너</div>
            </div>
            <form th:action="@{/shop/banner}" method="post" id="bannerForm">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <div class="item-list">
                    <label th:each="opt,iter : ${bannerOptions}"
                           class="btn btn-outline"
                           th:classappend="${ownedBanners.contains(opt.value())} ? ' owned' : ''"
                           th:style="|padding:12px; color:#fff; background:${opt.gradient()}; display:flex; flex-direction:column; align-items:flex-start; gap:4px; cursor:pointer;|">
                        <input type="radio" name="banner" th:id="|banner_${iter.index}|" th:value="${opt.value()}" style="position:absolute; opacity:0; pointer-events:none;">
                        <div style="font-weight:700;" th:text="${opt.label()}">배너</div>
                        <div style="font-size:12px; color:#f8fafc;"
                             th:text="${ownedBanners.contains(opt.value()) ? '보유' : opt.cost() + 'P'}">가격</div>
                    </label>
                </div>
                <div style="margin-top:10px; display:flex; justify-content:flex-end;">
                    <button class="btn" type="submit">구매 / 적용</button>
                </div>
            </form>
        </div>

        <div class="shop-card" style="grid-column:span 2;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div style="font-weight:700;">뱃지</div>
                <div style="color:#6b7280; font-size:12px;">조건 달성 시 자동 해금</div>
            </div>
            <div class="item-list" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));">
                <form th:each="b : ${badges}"
                      th:action="@{/shop/badge}"
                      method="post"
                      class="badge-tile"
                      th:classappend="${b.unlocked()} ? '' : ' locked'">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <input type="hidden" name="badgeId" th:value="${b.id()}">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-weight:700;" th:text="${b.name()}">배지</div>
                        <span class="pill-soft" th:if="${b.equipped()}" style="background:#eef2ff; color:#111827;">장착중</span>
                    </div>
                    <div style="font-size:12px; color:#6b7280;" th:text="${b.desc()}">설명</div>
                    <div style="font-size:12px; color:#9ca3af;" th:text="${b.unlocked() ? '해금됨' : b.requirement()}">조건</div>
                    <button class="btn btn-outline" type="submit"
                            th:disabled="${!b.unlocked()}"
                            th:text="${b.unlocked() ? '장착하기' : '해금 필요'}"></button>
                </form>
            </div>
        </div>

        <div class="shop-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div style="font-weight:700;">부스트 아이템</div>
                <div style="color:#6b7280; font-size:12px;">포인트로 구매</div>
            </div>
            <form th:action="@{/shop/boost}" method="post" class="boost-grid">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <div class="badge-tile">
                    <div style="font-weight:700;">연속 보호</div>
                    <div style="font-size:12px; color:#6b7280;">연속일이 끊길 때 한번 보호</div>
                    <button class="btn btn-outline" type="submit" name="boostId" value="shield"
                            th:text="|${boostPrices.get('shield')}P|">20P</button>
                </div>
                <div class="badge-tile">
                    <div style="font-weight:700;">추가 문제 +10</div>
                    <div style="font-size:12px; color:#6b7280;">하루 생성 한도를 +10 확장</div>
                    <button class="btn btn-outline" type="submit" name="boostId" value="extra10"
                            th:text="|${boostPrices.get('extra10')}P|">15P</button>
                </div>
                <div class="badge-tile">
                    <div style="font-weight:700;">추가 문제 +20</div>
                    <div style="font-size:12px; color:#6b7280;">하루 생성 한도를 +20 확장</div>
                    <button class="btn btn-outline" type="submit" name="boostId" value="extra20"
                            th:text="|${boostPrices.get('extra20')}P|">25P</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', ()=>{
        const selectFirst = (formId) => {
            const form = document.getElementById(formId);
            if (!form) return;
            const radios = Array.from(form.querySelectorAll('input[type="radio"]'));
            if (radios.length && !radios.some(r=>r.checked)) {
                radios[0].checked = true;
                radios[0].parentElement.classList.add('active');
            }
            radios.forEach(r=>{
                const parent = r.parentElement;
                parent.addEventListener('click', (e)=>{
                    e.preventDefault();
                    radios.forEach(x=>x.parentElement.classList.remove('active'));
                    r.checked = true;
                    parent.classList.add('active');
                });
            });
        };
        selectFirst('avatarForm');
        selectFirst('bannerForm');
    });
</script>
</body>
</html>
