<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      th:replace="layout :: layout (~{::body})"
      th:with="content='this :: content'">

<body>
<div th:fragment="content">

    <h1 class="page-title">ë‚´ê°€ ì—…ë¡œë“œí•œ PDF ëª©ë¡</h1>

    <div th:if="${error}" class="alert alert-danger" style="margin-bottom:12px;">
        <span th:text="${error}"></span>
    </div>
    <div th:if="${message}" class="alert alert-success" style="margin-bottom:12px;">
        <span th:text="${message}"></span>
    </div>
    <div th:if="${errorFileId}" class="alert alert-warning" style="margin-bottom:12px;">
        <div style="margin-bottom:8px;">
            <strong>PDF ì½ê¸° ì˜¤ë¥˜</strong>ê°€ ë°œìƒí•œ íŒŒì¼:
            <span th:text="${errorFileName}" style="font-weight:600;"></span>
        </div>
        <form th:action="@{/document/force-delete/{id}(id=${errorFileId})}"
              method="post"
              onsubmit="return confirm('ë¬¸ì œì™€ PDFë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?');">
            <input type="hidden"
                   th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}" />
            <button type="submit" class="btn btn-outline" style="padding:4px 10px; font-size:12px;">
                âš  ë¬¸ì œì™€ í•¨ê»˜ ê°•ì œ ì‚­ì œ
            </button>
        </form>
    </div>

    <!-- ìƒë‹¨ ì•¡ì…˜ ì˜ì—­ -->
    <div class="card" style="margin-bottom: 16px;">
        <div style="
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:12px;
            flex-wrap:wrap;
        ">
            <span style="color:#555; font-size:14px;">
                ì´ <span th:text="${#lists.size(files)}">0</span>ê°œ
            </span>

            <a th:href="@{/document/upload}" class="btn">
                â• ìƒˆ PDF ì—…ë¡œë“œ
            </a>
        </div>
    </div>

    <!-- ëª©ë¡ í…Œì´ë¸” ì¹´ë“œ -->
    <div class="card">
        <table class="table">
            <thead>
            <tr>
                <th>ID</th>
                <th>ì›ë³¸ íŒŒì¼ëª…</th>
                <th>ì €ì¥ íŒŒì¼ëª…</th>
                <th>íŒŒì¼ í¬ê¸° (byte)</th>
                <th>ì—…ë¡œë“œ ì‹œê°</th>
                <th style="width:110px; text-align:center;">ì•¡ì…˜</th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${#lists.isEmpty(files)}">
                <td colspan="6" style="text-align:center; padding:24px 0; color:#777;">
                    ì—…ë¡œë“œëœ PDFê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € íŒŒì¼ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.
                </td>
            </tr>
            <tr th:each="file : ${files}">
                <td th:text="${file.id}"></td>
                <td th:text="${file.originalFilename}"></td>
                <td th:text="${file.storedFilename}"></td>
                <td th:text="${file.fileSize}"></td>
                <td th:text="${file.uploadedAt}"></td>
                <td style="text-align:center;">
                    <!-- ì‚­ì œ ë²„íŠ¼ (POST + CSRF) -->
                    <form th:action="@{/document/delete/{id}(id=${file.id})}"
                          method="post"
                          style="display:inline;"
                          onsubmit="return confirm('ì •ë§ ì´ PDFë¥¼ ì‚­ì œí• ê¹Œìš”?');">

                        <input type="hidden"
                               th:name="${_csrf.parameterName}"
                               th:value="${_csrf.token}" />

                        <button type="submit"
                                class="btn btn-outline"
                                style="padding:4px 10px; font-size:12px;">
                            ğŸ—‘ ì‚­ì œ
                        </button>
                    </form>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- í•˜ë‹¨ ì•¡ì…˜ -->
    <div style="margin-top: 10px;">
        <form th:action="@{/document/makeprob}"
              method="get"
              id="makeProblemForm"
              style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
            <input type="text"
                   name="stylePrompt"
                   style="flex:1; min-width:260px; padding:8px 12px; border:1px solid #ccc; border-radius:6px; color:#333;"
                   placeholder="ì›í•˜ëŠ” ìŠ¤íƒ€ì¼ë¡œ ë¬¸ì œë¥¼ ì œì‘í•´ë´ìš”"
                   th:value="${stylePrompt}">
            <button type="submit" class="btn btn-outline" id="makeProblemButton">
                ğŸ“ ë¬¸ì œ ë§Œë“¤ê¸°
            </button>
        </form>
    </div>

    <!-- ë¬¸ì œ ìƒì„± ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loadingOverlay" style="
        position:fixed;
        inset:0;
        background:rgba(17,24,39,0.55);
        display:none;
        align-items:center;
        justify-content:center;
        z-index:9999;
        backdrop-filter:blur(2px);
    ">
        <div style="
            background:#fff;
            padding:20px 22px;
            border-radius:14px;
            box-shadow:0 18px 40px rgba(0,0,0,0.28);
            display:flex;
            align-items:center;
            gap:14px;
            min-width:260px;
        ">
            <div style="
                width:38px; height:38px;
                border-radius:50%;
                border:4px solid #e5e7eb;
                border-top-color: var(--brand);
                animation: spin 1s linear infinite;
            "></div>
            <div>
                <div style="font-weight:700; color:#111827;">ë¬¸ì œë¥¼ ë§Œë“œëŠ” ì¤‘...</div>
                <div style="font-size:13px; color:#6b7280;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>
            </div>
        </div>
    </div>

</div>
<style>
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('makeProblemForm');
        const overlay = document.getElementById('loadingOverlay');
        const button = document.getElementById('makeProblemButton');

        if (form && overlay) {
            form.addEventListener('submit', function () {
                overlay.style.display = 'flex';
                if (button) {
                    button.disabled = true;
                    button.textContent = 'ìƒì„± ì¤‘...';
                }
            });
        }
    });
</script>
</body>
</html>
