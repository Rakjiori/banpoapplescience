<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      th:replace="layout :: layout (~{::body})"
      th:with="content='this :: content'">

<body>
<div th:fragment="content">

    <h1 class="page-title">내가 업로드한 PDF 목록</h1>
    <p th:if="${selectedFolder != null}"
       style="margin-top:-6px; color:#6b7280; font-size:14px;">
        현재 폴더: <strong th:text="${selectedFolder.name}"></strong>
    </p>

    <div th:if="${#lists.isEmpty(folders)}" class="card" style="margin-top:12px;">
        <p style="margin:0 0 8px; font-weight:700;">폴더가 없습니다.</p>
        <p style="margin:0 0 12px; color:#6b7280;">먼저 폴더를 만든 후 PDF를 업로드해 주세요.</p>
        <a href="/folders" class="btn btn-outline">📂 새 폴더 추가하기</a>
    </div>

    <div th:if="${!#lists.isEmpty(folders)}">

    <div th:if="${error}" class="alert alert-danger" style="margin-bottom:12px;">
        <span th:text="${error}"></span>
    </div>
    <div th:if="${message}" class="alert alert-success" style="margin-bottom:12px;">
        <span th:text="${message}"></span>
    </div>
    <div th:if="${errorFileId}" class="alert alert-warning" style="margin-bottom:12px;">
        <div style="margin-bottom:8px;">
            <strong>PDF 읽기 오류</strong>가 발생한 파일:
            <span th:text="${errorFileName}" style="font-weight:600;"></span>
        </div>
        <form th:action="@{/document/force-delete/{id}(id=${errorFileId})}"
              method="post"
              onsubmit="return confirm('문제와 PDF를 모두 삭제할까요?');">
            <input type="hidden"
                   th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}" />
            <input type="hidden" name="folderId"
                   th:value="${selectedFolder != null ? selectedFolder.id : null}" />
            <button type="submit" class="btn btn-outline" style="padding:4px 10px; font-size:12px;">
                ⚠ 문제와 함께 강제 삭제
            </button>
        </form>
    </div>

    <!-- 상단 액션 영역 -->
    <div class="card" style="margin-bottom: 16px;">
        <div style="
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:12px;
            flex-wrap:wrap;
        ">
            <form th:action="@{/document/list}" method="get" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <select id="folderSelect"
                        name="folderId"
                        onchange="this.form.submit()"
                        style="min-width:200px; padding:8px 10px; border-radius:8px; border:1px solid #d1d5db;">
                    <option value="" disabled th:selected="${selectedFolder == null}">폴더를 선택하세요</option>
                    <option th:each="folder : ${folders}"
                            th:value="${folder.id}"
                            th:text="${folder.name}"
                            th:selected="${selectedFolder != null and selectedFolder.id == folder.id}">
                    </option>
                </select>
            </form>
            <div style="display:flex; gap:8px; align-items:center;">
                <span style="color:#555; font-size:14px;">
                    총 <span th:text="${#lists.size(files)}">0</span>개
                </span>
                <a th:href="@{/folders}" class="btn btn-outline" style="white-space:nowrap;">
                    📂 폴더 관리
                </a>
                <button type="button"
                        id="openUploadModal"
                        class="btn"
                        style="white-space:nowrap;"
                        th:data-selected-folder="${selectedFolder != null ? selectedFolder.id : ''}">
                    ➕ 새 PDF 업로드
                </button>
            </div>
        </div>
    </div>

    <!-- 목록 테이블 카드 -->
    <div class="card" style="overflow-x:auto;">
        <table class="table" style="min-width:720px; white-space:nowrap;">
            <thead>
            <tr>
                <th class="text-center col-compact" style="font-weight:700;">#</th>
                <th class="text-left filename-cell" style="font-weight:700;">원본 파일명</th>
                <th class="text-right col-compact mono" style="font-weight:700;">파일 크기 (MB)</th>
                <th class="text-center mono" style="font-weight:700;">업로드 시각</th>
                <th class="text-center col-wide" style="font-weight:700;">내용 요약</th>
                <th class="text-center col-compact" style="font-weight:700;">액션</th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${#lists.isEmpty(files)}">
                <td colspan="7" style="text-align:center; padding:24px 0; color:#777;">
                    업로드된 PDF가 없습니다. 먼저 파일을 업로드해 주세요.
                </td>
            </tr>
            <tr th:each="file, stat : ${files}">
                <td class="text-center mono" th:text="${stat.index + 1}"></td>
                <td class="filename-cell" th:text="${file.originalFilename}"></td>
                <td class="text-right mono" th:text="${#numbers.formatDecimal(file.fileSize / 1048576.0, 1, 1)} + ' MB'"></td>
                <td class="text-center mono" th:text="${#temporals.format(file.uploadedAt, 'yy-MM-dd HH:mm')}"></td>
                <td class="summary-cell col-wide">
                    <a class="btn summary-btn motion-lift"
                       th:href="@{/document/summary/{id}(id=${file.id}, folderId=${selectedFolder != null ? selectedFolder.id : null})}">
                        <span class="summary-icon">📝</span>
                        <span>내용 요약</span>
                    </a>
                </td>
                <td style="text-align:center;">
                    <!-- 삭제 버튼 (POST + CSRF) -->
                    <form th:action="@{/document/force-delete/{id}(id=${file.id})}"
                          method="post"
                          style="display:inline;"
                          onsubmit="return confirm('정말 이 PDF를 삭제할까요?');">

                        <input type="hidden"
                               th:name="${_csrf.parameterName}"
                               th:value="${_csrf.token}" />
                        <input type="hidden" name="folderId"
                               th:value="${selectedFolder != null ? selectedFolder.id : null}" />

                        <button type="submit"
                                class="btn btn-outline"
                                style="padding:4px 10px; font-size:12px;">
                            🗑 삭제
                        </button>
                    </form>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 하단 액션 -->
    <div style="margin-top: 10px;">
        <form th:action="@{/document/makeprob}"
              method="get"
              id="makeProblemForm"
              style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
            <input type="hidden" name="folderId"
                   th:value="${selectedFolder != null ? selectedFolder.id : null}">
            <input type="text"
                   name="stylePrompt"
                   style="flex:1; min-width:260px; padding:8px 12px; border:1px solid #ccc; border-radius:6px; color:#333;"
                   placeholder="원하는 스타일로 문제를 제작해봐요"
                   th:value="${stylePrompt}">
            <button type="submit" class="btn btn-outline" id="makeProblemButton">
                📝 문제 만들기
            </button>
        </form>
    </div>

    </div>

    <!-- 문제 생성 로딩 오버레이 -->
    <div id="loadingOverlay" style="
        position:fixed;
        inset:0;
        background:rgba(17,24,39,0.55);
        display:none;
        align-items:center;
        justify-content:center;
        z-index:9999;
        backdrop-filter:blur(2px);
    ">
        <div style="
            background:#fff;
            padding:20px 22px;
            border-radius:14px;
            box-shadow:0 18px 40px rgba(0,0,0,0.28);
            display:flex;
            align-items:center;
            gap:14px;
            min-width:260px;
        ">
            <div style="
                width:38px; height:38px;
                border-radius:50%;
                border:4px solid #e5e7eb;
                border-top-color: var(--brand);
                animation: spin 1s linear infinite;
            "></div>
            <div>
                <div style="font-weight:700; color:#111827;">문제를 만드는 중...</div>
                <div style="font-size:13px; color:#6b7280;">잠시만 기다려주세요.</div>
            </div>
        </div>
    </div>

    <!-- PDF 업로드 모달 -->
    <div id="uploadModal" style="
        position:fixed;
        inset:0;
        background:rgba(17,24,39,0.6);
        display:none;
        align-items:center;
        justify-content:center;
        z-index:10010;
        backdrop-filter:blur(3px);
    ">
        <div style="
            background:#fff;
            border-radius:14px;
            width:min(540px, 92vw);
            box-shadow:0 24px 60px rgba(0,0,0,0.28);
            padding:18px;
            display:flex;
            flex-direction:column;
            gap:14px;
        ">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                <div>
                    <div style="font-size:18px; font-weight:700;">새 PDF 업로드</div>
                    <div style="font-size:13px; color:#6b7280;">현재 페이지를 벗어나지 않고 바로 업로드합니다.</div>
                </div>
                <button type="button" class="btn btn-outline" data-role="upload-close" style="padding:6px 12px;">닫기</button>
            </div>

            <form id="uploadForm"
                  method="post"
                  enctype="multipart/form-data"
                  th:action="@{/document/upload}"
                  style="display:flex; flex-direction:column; gap:12px;">

                <input type="hidden"
                       th:name="${_csrf.parameterName}"
                       th:value="${_csrf.token}" />

                <div>
                    <label for="uploadFileInput" style="display:block; font-weight:600; margin-bottom:6px;">PDF 파일 선택</label>
                    <label for="uploadFileInput"
                           class="file-picker"
                           style="display:inline-flex; align-items:center; gap:10px; padding:10px 14px; border:1px dashed #cbd5e1; border-radius:12px; background:#f8fafc; cursor:pointer; font-weight:600; color:#0f172a;">
                        <span style="font-size:18px;">📁</span>
                        <span id="filePickerLabel">클릭해서 PDF를 선택하세요</span>
                    </label>
                    <input id="uploadFileInput"
                           type="file"
                           name="pdfFile"
                           accept="application/pdf"
                           required
                           style="display:none;">
                </div>

                <div>
                    <label for="uploadFolderSelect" style="display:block; font-weight:600; margin-bottom:6px;">저장할 폴더</label>
                    <select id="uploadFolderSelect"
                            name="folderId"
                            style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid #d1d5db;">
                        <option value="" th:selected="${selectedFolder == null}">폴더 없이 업로드</option>
                        <option th:each="folder : ${folders}"
                                th:value="${folder.id}"
                                th:text="${folder.name}"
                                th:selected="${selectedFolder != null and selectedFolder.id == folder.id}">
                        </option>
                    </select>
                    <p style="margin:6px 0 0; font-size:12px; color:#9ca3af;">
                        폴더가 없다면 <a href="/folders">폴더 페이지</a>에서 추가하세요.
                    </p>
                </div>

                <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:4px;">
                    <button type="button" class="btn btn-outline" data-role="upload-close">취소</button>
                    <button type="submit" class="btn" id="uploadSubmitButton">업로드</button>
                </div>
            </form>
        </div>
    </div>

</div>
<style>
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('makeProblemForm');
        const overlay = document.getElementById('loadingOverlay');
        const button = document.getElementById('makeProblemButton');
        const folderSelect = document.getElementById('folderSelect');

        if (form && overlay) {
            form.addEventListener('submit', function () {
                overlay.style.display = 'flex';
                if (button) {
                    button.disabled = true;
                    button.textContent = '생성 중...';
                }
            });
        }

        // 업로드 모달
        const uploadModal = document.getElementById('uploadModal');
        const openUploadBtn = document.getElementById('openUploadModal');
        const uploadFolderSelect = document.getElementById('uploadFolderSelect');
        const uploadForm = document.getElementById('uploadForm');
        const uploadSubmitButton = document.getElementById('uploadSubmitButton');
        const uploadFileInput = document.getElementById('uploadFileInput');
        const filePickerLabel = document.getElementById('filePickerLabel');
        const closeUploadModal = () => {
            if (uploadModal) uploadModal.style.display = 'none';
        };
        const openUpload = () => {
            if (!uploadModal) return;
            uploadModal.style.display = 'flex';
            if (uploadFolderSelect) {
                const preselect = openUploadBtn?.dataset.selectedFolder;
                uploadFolderSelect.value = preselect || '';
            }
        };

        openUploadBtn?.addEventListener('click', (e) => {
            e.preventDefault();
            openUpload();
        });
        uploadModal?.addEventListener('click', (e) => {
            if (e.target === uploadModal) closeUploadModal();
    });
    document.querySelectorAll('[data-role="upload-close"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            closeUploadModal();
        });
    });
    if (uploadForm && uploadSubmitButton) {
        uploadForm.addEventListener('submit', () => {
            uploadSubmitButton.disabled = true;
            uploadSubmitButton.textContent = '업로드 중...';
            });
        }
        if (uploadFileInput && filePickerLabel) {
            uploadFileInput.addEventListener('change', () => {
                const fileName = uploadFileInput.files && uploadFileInput.files.length > 0
                    ? uploadFileInput.files[0].name
                    : '클릭해서 PDF를 선택하세요';
                filePickerLabel.textContent = fileName;
            });
        }
        if (folderSelect) {
            folderSelect.addEventListener('change', () => {
                folderSelect.closest('form')?.submit();
            });
        }

        // 요약 버튼에 라이트 애니메이션
        const summaryButtons = document.querySelectorAll('.summary-btn');
        summaryButtons.forEach(btn => {
            btn.addEventListener('mousemove', (e) => {
                const rect = btn.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                btn.style.setProperty('--x', `${x}px`);
                btn.style.setProperty('--y', `${y}px`);
            });
            btn.addEventListener('mouseleave', () => {
                btn.style.removeProperty('--x');
                btn.style.removeProperty('--y');
            });
        });
    });
</script>
</body>
</html>
