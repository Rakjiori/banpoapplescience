<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      th:replace="layout :: layout (~{::body})"
      th:with="content='this :: content'">

<body>
<div th:fragment="content">

<style>
    .upload-bar {
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        flex-wrap:wrap;
        background:#1d2a44;
        color:#fff;
        padding:14px 16px;
        border-radius:14px;
        box-shadow:0 14px 36px rgba(15,23,42,0.35);
    }
    .upload-bar h2 { margin:0; font-size:18px; }
    .upload-btn-primary {
        background:#22d3ee;
        color:#0f172a;
        border:none;
        padding:10px 14px;
        border-radius:10px;
        font-weight:700;
        cursor:pointer;
        box-shadow:0 10px 24px rgba(34,211,238,0.35);
    }
    .upload-btn-primary:hover { filter:brightness(0.95); }
    .table.sleek { width:100%; border-collapse:separate; border-spacing:0; }
    .table.sleek th, .table.sleek td { padding:12px 10px; border-bottom:1px solid #e5e7eb; text-align:left; }
    .table.sleek th { background:#f8fafc; font-weight:700; color:#0f172a; }
    .file-row:hover { background:#f9fafb; }
    .pill-soft { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#eef2ff; color:#312e81; font-weight:700; }
</style>

    <h1 class="page-title">ë‚´ê°€ ì—…ë¡œë“œí•œ PDF ëª©ë¡</h1>
    <p th:if="${selectedFolder != null}"
       style="margin-top:-6px; color:#6b7280; font-size:14px;">
        í˜„ì¬ í´ë”: <strong th:text="${selectedFolder.name}"></strong>
    </p>

    <div th:if="${error}" class="alert alert-danger" style="margin-bottom:12px;">
        <span th:text="${error}"></span>
    </div>
    <div th:if="${message}" class="alert alert-success" style="margin-bottom:12px;">
        <span th:text="${message}"></span>
    </div>
    <div th:if="${errorFileId}" class="alert alert-warning" style="margin-bottom:12px;">
        <div style="margin-bottom:8px;">
            <strong>PDF ì½ê¸° ì˜¤ë¥˜</strong>ê°€ ë°œìƒí•œ íŒŒì¼:
            <span th:text="${errorFileName}" style="font-weight:600;"></span>
        </div>
        <form th:action="@{/document/force-delete/{id}(id=${errorFileId})}"
              method="post"
              onsubmit="return confirm('ë¬¸ì œì™€ PDFë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?');">
            <input type="hidden"
                   th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}" />
            <input type="hidden" name="folderId"
                   th:value="${selectedFolder != null ? selectedFolder.id : null}" />
            <button type="submit" class="btn btn-outline" style="padding:4px 10px; font-size:12px;">
                âš  ë¬¸ì œì™€ í•¨ê»˜ ê°•ì œ ì‚­ì œ
            </button>
        </form>
    </div>

    <!-- ìƒë‹¨ ì•¡ì…˜ ì˜ì—­ -->
    <div class="card" style="margin-bottom: 16px;">
        <div style="
            display:flex;
            flex-direction:column;
            gap:12px;
        ">
            <form th:action="@{/document/list}" method="get" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <select name="folderId"
                        style="min-width:200px; padding:8px 10px; border-radius:8px; border:1px solid #d1d5db;"
                        onchange="this.form.submit();">
                    <option value="" th:selected="${selectedFolder == null}">ì „ì²´ í´ë”</option>
                    <option th:each="folder : ${folders}"
                            th:value="${folder.id}"
                            th:text="${folder.name}"
                            th:selected="${selectedFolder != null and selectedFolder.id == folder.id}">
                    </option>
                </select>
                <input type="hidden" name="folderId_hidden" value="">
            </form>
            <div class="upload-bar">
                <div>
                    <h2>PDF ì—…ë¡œë“œ</h2>
                    <div class="pill-soft">ì´ <span th:text="${#lists.size(files)}">0</span>ê°œ</div>
                </div>
                <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                    <a th:href="@{/folders}" class="btn btn-outline" style="white-space:nowrap; background:#fff; color:#0f172a; border-color:rgba(255,255,255,0.3);">
                        ğŸ“‚ í´ë” ê´€ë¦¬
                    </a>
                    <button type="button"
                            class="upload-btn-primary"
                            id="instantUploadButton">
                        â• ìƒˆ PDF ì—…ë¡œë“œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ëª©ë¡ í…Œì´ë¸” ì¹´ë“œ -->
    <div class="card">
        <table class="table sleek">
            <thead>
            <tr>
                <th>ì›ë³¸ íŒŒì¼ëª…</th>
                <th style="width:120px;">ìš©ëŸ‰(MB)</th>
                <th style="width:160px;">ì—…ë¡œë“œ ì‹œê°</th>
                <th>ê´€ë¦¬</th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${#lists.isEmpty(files)}">
                <td colspan="5" style="text-align:center; padding:24px 0; color:#777;">
                    ì—…ë¡œë“œëœ PDFê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € íŒŒì¼ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.
                </td>
            </tr>
            <tr th:each="file : ${files}" class="file-row">
                <td th:text="${file.originalFilename}"></td>
                <td th:text="${#numbers.formatDecimal(file.fileSize / 1048576.0, 1, 1)}"></td>
                <td th:text="${#temporals.format(file.uploadedAt, 'yy-MM-dd HH:mm')}"></td>
                <td>
                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                        <form th:action="@{/document/delete/{id}(id=${file.id})}"
                              method="post"
                              style="display:inline;"
                              onsubmit="return confirm('ì •ë§ ì´ PDFë¥¼ ì‚­ì œí• ê¹Œìš”?');">
                            <input type="hidden"
                                   th:name="${_csrf.parameterName}"
                                   th:value="${_csrf.token}" />
                            <input type="hidden" name="folderId"
                                   th:value="${selectedFolder != null ? selectedFolder.id : null}" />
                            <button type="submit"
                                    class="btn btn-outline"
                                    style="padding:4px 10px; font-size:12px;">
                                ğŸ—‘ ì‚­ì œ
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

</div>

<form id="instantUploadForm"
      th:action="@{/document/upload}"
      method="post"
      enctype="multipart/form-data"
      style="display:none;">
    <input type="file" name="pdfFile" id="instantUploadInput" accept="application/pdf">
    <input type="hidden" name="folderId" th:value="${selectedFolder != null ? selectedFolder.id : ''}">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
</form>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('instantUploadButton');
        const input = document.getElementById('instantUploadInput');
        const form = document.getElementById('instantUploadForm');
        if (btn && input && form) {
            btn.addEventListener('click', () => input.click());
            input.addEventListener('change', () => {
                if (input.files && input.files.length > 0) {
                    form.submit();
                }
            });
        }
    });
</script>
<style>
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('makeProblemForm');
        const overlay = document.getElementById('loadingOverlay');
        const button = document.getElementById('makeProblemButton');

        if (form && overlay) {
            form.addEventListener('submit', function () {
                overlay.style.display = 'flex';
                if (button) {
                    button.disabled = true;
                    button.textContent = 'ìƒì„± ì¤‘...';
                }
            });
        }

        const modal = document.createElement('div');
        modal.id = 'textPreviewModal';
        modal.style.position = 'fixed';
        modal.style.inset = '0';
        modal.style.background = 'rgba(17,24,39,0.55)';
        modal.style.display = 'none';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.style.zIndex = '10000';
        modal.innerHTML = `
            <div style="
                background:#fff;
                padding:18px;
                border-radius:14px;
                width: min(900px, 90vw);
                max-height:80vh;
                display:flex;
                flex-direction:column;
                box-shadow:0 18px 40px rgba(0,0,0,0.28);
            ">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                    <strong id="previewTitle" style="font-size:16px;"></strong>
                    <button type="button" class="btn btn-outline" id="previewCloseBtn" style="padding:6px 12px;">ë‹«ê¸°</button>
                </div>
                <div id="previewBody" style="margin-top:12px; padding:12px; border:1px solid #e5e7eb; border-radius:10px; overflow:auto; white-space:pre-wrap; background:#f9fafb; flex:1;"></div>
            </div>
        `;
        document.body.appendChild(modal);

        const closeModal = () => modal.style.display = 'none';
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });
        modal.querySelector('#previewCloseBtn').addEventListener('click', closeModal);

        document.querySelectorAll('[data-role="preview-btn"]').forEach(btn => {
            btn.addEventListener('click', () => {
                const text = btn.dataset.text || 'ì¶”ì¶œëœ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
                const title = btn.dataset.title || 'PDF ë‚´ìš©';
                document.getElementById('previewTitle').textContent = title;
                document.getElementById('previewBody').textContent = text;
                modal.style.display = 'flex';
            });
        });
    });
</script>
</body>
</html>
