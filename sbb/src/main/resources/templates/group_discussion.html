<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="layout :: layout(~{::body})">
<body>
<div>
    <a th:href="@{/groups/{id}(id=${group.id})}" class="btn btn-outline" style="margin-bottom:10px;">â† ê·¸ë£¹ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    <h1 class="page-title">ê·¸ë£¹ í† ë¡ </h1>
    <p style="margin-top:-6px; color:#6b7280;">
        <span th:text="${group.name}"></span> Â· <span th:text="${question.questionText}">ë¬¸ì œ</span>
    </p>

    <div class="card">
        <div style="padding-bottom:10px; border-bottom:1px solid #e5e7eb; margin-bottom:10px;">
            <div style="display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
                <span style="display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:#eef2ff; color:#3730a3; font-weight:700; font-size:12px;"
                      th:text="${question.numberTag != null ? 'ë¬¸ì œ ' + question.numberTag : 'ë¬¸ì œ'}">ë¬¸ì œ</span>
                <span style="color:#9ca3af; font-size:11px;" th:text="${question.createdAtFormatted}"></span>
                <a th:href="@{/quiz/solve/{id}(id=${question.id}, groupId=${group.id}, discussionQuestionId=${question.id})}"
                   class="btn btn-outline" style="padding:6px 10px; font-size:12px; white-space:nowrap;">í’€ê¸°</a>
            </div>
            <p style="margin:8px 0 0; font-weight:600; white-space:pre-wrap; font-size:13px; line-height:1.4;" th:text="${question.questionText}">ë¬¸ì œ ë‚´ìš©</p>

            <div th:if="${choiceList != null and !#lists.isEmpty(choiceList)}"
                 style="margin-top:8px; display:flex; flex-direction:column; gap:6px; font-size:12px;">
                <div th:each="choice : ${choiceList}"
                     style="padding:8px; border:1px solid #e5e7eb; border-radius:8px; display:flex; gap:8px; align-items:flex-start; background:#f8fafc;">
                    <strong style="min-width:22px;"
                            th:text="${choice.number != null ? choice.number + '.' : 'ë³´ê¸°'}">ë³´ê¸°</strong>
                    <span style="white-space:pre-wrap; color:#111827;" th:text="${choice.text}"></span>
                </div>
            </div>
            <div th:if="${choiceList == null or #lists.isEmpty(choiceList)}" style="margin-top:6px; color:#6b7280; font-size:12px;">
                ê°ê´€ì‹ ë³´ê¸°ê°€ ì—†ëŠ” ì£¼ê´€ì‹ ë¬¸ì œì…ë‹ˆë‹¤.
            </div>
            <!-- ì •ë‹µ/í•´ì„¤ì€ í† ë¡  í˜ì´ì§€ì—ì„œëŠ” ìˆ¨ê¹€ -->
        </div>

        <h3 style="margin:0 0 8px; font-size:15px;">ëŒ“ê¸€</h3>
        <div style="display:flex; flex-direction:column; gap:8px;">
            <div th:each="item : ${comments}"
                 style="padding:10px; border:1px solid #e5e7eb; border-radius:10px; display:flex; gap:8px; align-items:flex-start; font-size:13px;">
                <div style="font-size:18px;"> 
                    <span th:text="${item.user.avatar != null ? item.user.avatar : 'ğŸ§‘'}">ğŸ§‘</span>
                </div>
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                        <strong class="comment-username" th:text="${item.user.username}" style="font-size:13px;">user</strong>
                        <div style="display:flex; align-items:center; gap:6px;">
                            <span style="color:#9ca3af; font-size:11px;"
                                  th:text="${#temporals.format(item.createdAt, 'yyyy.MM.dd HH:mm')}">date</span>
                            <div th:if="${currentUserId != null and currentUserId == item.user.id}" style="display:flex; gap:4px;">
                                <button type="button"
                                        class="btn btn-outline"
                                        style="padding:4px 8px; font-size:11px;"
                                        th:attr="data-edit-target=${item.id}"
                                        onclick="toggleEdit(this)">
                                    ìˆ˜ì •
                                </button>
                                <form th:action="@{/groups/{groupId}/discussion/{questionId}/comment/{commentId}/delete(groupId=${group.id},questionId=${question.id},commentId=${item.id})}"
                                      method="post"
                                      style="margin:0;">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                    <button type="submit"
                                            class="btn btn-outline"
                                            style="padding:4px 8px; font-size:11px;"
                                            onclick="return confirm('ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?');">
                                        ì‚­ì œ
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div th:attr="data-comment-text=${item.id}"
                         style="margin-top:4px; white-space:pre-wrap; font-size:12px;"
                         th:text="${item.content}"></div>
                    <form th:action="@{/groups/{groupId}/discussion/{questionId}/comment/{commentId}/edit(groupId=${group.id},questionId=${question.id},commentId=${item.id})}"
                          method="post"
                          th:attr="data-edit-form=${item.id}"
                          style="display:none; margin-top:6px; gap:6px; align-items:flex-start;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <textarea name="content"
                                  rows="2"
                                  style="flex:1; padding:10px; border:1px solid #cbd5e1; border-radius:10px; resize:vertical; font-size:12px; font-family:'Segoe UI','Noto Sans KR',sans-serif;"
                                  th:text="${item.content}"></textarea>
                        <div style="display:flex; flex-direction:column; gap:4px;">
                            <button type="submit" class="btn" style="padding:8px 10px; font-size:12px;">ì €ì¥</button>
                            <button type="button" class="btn btn-outline" style="padding:8px 10px; font-size:12px;" onclick="toggleEditButton(this)">ì·¨ì†Œ</button>
                        </div>
                    </form>
                </div>
            </div>
            <div th:if="${#lists.isEmpty(comments)}" style="color:#6b7280;">ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ ë³´ì„¸ìš”.</div>
        </div>

        <form th:action="@{/groups/{groupId}/discussion/{questionId}(groupId=${group.id},questionId=${question.id})}"
              method="post"
              style="margin-top:12px; display:flex; gap:8px; align-items:flex-start;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <textarea name="content" rows="2" required
                      style="flex:1; padding:12px; border:1px solid #cbd5e1; border-radius:12px; resize:vertical; font-size:14px; font-family:'Segoe UI','Noto Sans KR',sans-serif;"
                      placeholder="ê·¸ë£¹ì›ë“¤ê³¼ ìƒê°ì„ ë‚˜ëˆ  ë³´ì„¸ìš”"></textarea>
            <button type="submit" class="btn" style="padding:10px 14px;">ë“±ë¡</button>
        </form>
    </div>
</div>
<script>
    function toggleEdit(button) {
        const id = button?.dataset?.editTarget;
        if (!id) return;
        const form = document.querySelector(`[data-edit-form="${id}"]`);
        const text = document.querySelector(`[data-comment-text="${id}"]`);
        if (!form || !text) return;
        const isOpen = form.style.display === 'flex';
        form.style.display = isOpen ? 'none' : 'flex';
        text.style.display = isOpen ? 'block' : 'none';
    }
    function toggleEditButton(btn) {
        const form = btn?.closest('form');
        if (!form) return;
        const id = form.dataset.editForm;
        const text = document.querySelector(`[data-comment-text="${id}"]`);
        form.style.display = 'none';
        if (text) text.style.display = 'block';
    }
</script>
</body>
</html>
