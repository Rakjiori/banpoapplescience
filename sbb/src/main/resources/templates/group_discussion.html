<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="layout :: layout(~{::body})">
<body>
<div>
    <a th:href="@{/groups/{id}(id=${group.id})}" class="btn btn-outline" style="margin-bottom:10px;">← 그룹으로 돌아가기</a>
    <h1 class="page-title">그룹 토론</h1>
    <p style="margin-top:-6px; color:#6b7280;">
        <span th:text="${group.name}"></span> · <span th:text="${question.questionText}">문제</span>
    </p>

    <div class="card">
        <div style="padding-bottom:10px; border-bottom:1px solid #e5e7eb; margin-bottom:10px;">
            <div style="display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
                <span style="display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:#eef2ff; color:#3730a3; font-weight:700; font-size:12px;"
                      th:text="${question.numberTag != null ? '문제 ' + question.numberTag : '문제'}">문제</span>
                <span style="color:#9ca3af; font-size:11px;" th:text="${question.createdAtFormatted}"></span>
                <a th:href="@{/quiz/solve/{id}(id=${question.id}, groupId=${group.id}, discussionQuestionId=${question.id})}"
                   class="btn btn-outline" style="padding:6px 10px; font-size:12px; white-space:nowrap;">풀기</a>
            </div>
            <p style="margin:8px 0 0; font-weight:600; white-space:pre-wrap; font-size:13px; line-height:1.4;" th:text="${question.questionText}">문제 내용</p>

            <div th:if="${choiceList != null and !#lists.isEmpty(choiceList)}"
                 style="margin-top:8px; display:flex; flex-direction:column; gap:6px; font-size:12px;">
                <div th:each="choice : ${choiceList}"
                     style="padding:8px; border:1px solid #e5e7eb; border-radius:8px; display:flex; gap:8px; align-items:flex-start; background:#f8fafc;">
                    <strong style="min-width:22px;"
                            th:text="${choice.number != null ? choice.number + '.' : '보기'}">보기</strong>
                    <span style="white-space:pre-wrap; color:#111827;" th:text="${choice.text}"></span>
                </div>
            </div>
            <div th:if="${choiceList == null or #lists.isEmpty(choiceList)}" style="margin-top:6px; color:#6b7280; font-size:12px;">
                객관식 보기가 없는 주관식 문제입니다.
            </div>
            <!-- 정답/해설은 토론 페이지에서는 숨김 -->
        </div>

        <h3 style="margin:0 0 8px; font-size:15px;">댓글</h3>
        <div style="display:flex; flex-direction:column; gap:8px;">
            <div th:each="item : ${comments}"
                 style="padding:10px; border:1px solid #e5e7eb; border-radius:10px; display:flex; gap:8px; align-items:flex-start; font-size:13px;">
                <div style="font-size:18px;"> 
                    <span th:text="${item.user.avatar != null ? item.user.avatar : '🧑'}">🧑</span>
                </div>
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                        <strong class="comment-username" th:text="${item.user.username}" style="font-size:13px;">user</strong>
                        <div style="display:flex; align-items:center; gap:6px;">
                            <span style="color:#9ca3af; font-size:11px;"
                                  th:text="${#temporals.format(item.createdAt, 'yyyy.MM.dd HH:mm')}">date</span>
                            <form th:if="${(currentUserId != null and currentUserId == item.user.id) or isAdmin}"
                                  th:action="@{/groups/{groupId}/discussion/{questionId}/comment/{commentId}/delete(groupId=${group.id},questionId=${question.id},commentId=${item.id})}"
                                  method="post"
                                  style="margin:0;">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                <button type="submit"
                                        class="btn btn-outline"
                                        style="padding:4px 8px; font-size:11px;"
                                        onclick="return confirm('댓글을 삭제할까요?');">
                                    삭제
                                </button>
                            </form>
                        </div>
                    </div>
                    <div th:attr="data-comment-text=${item.id}"
                         style="margin-top:4px; white-space:pre-wrap; font-size:12px;"
                         th:text="${item.content}"></div>
                </div>
            </div>
            <div th:if="${#lists.isEmpty(comments)}" style="color:#6b7280;">첫 댓글을 남겨 보세요.</div>
        </div>

        <form th:action="@{/groups/{groupId}/discussion/{questionId}(groupId=${group.id},questionId=${question.id})}"
              method="post"
              style="margin-top:12px; display:flex; gap:8px; align-items:flex-start;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <textarea name="content" rows="2" required
                      style="flex:1; padding:12px; border:1px solid #cbd5e1; border-radius:12px; resize:vertical; font-size:14px; font-family:'Segoe UI','Noto Sans KR',sans-serif;"
                      placeholder="그룹원들과 생각을 나눠 보세요"></textarea>
            <button type="submit" class="btn" style="padding:10px 14px;">등록</button>
        </form>
    </div>
</div>
</body>
</html>
