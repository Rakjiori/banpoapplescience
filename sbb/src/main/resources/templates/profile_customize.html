<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="layout :: layout(~{::body})">
<body>
<div>
    <a href="/profile" class="btn btn-outline" style="margin-bottom:10px;">â† í”„ë¡œí•„ë¡œ ëŒì•„ê°€ê¸°</a>
    <h1 class="page-title">í”„ë¡œí•„ ê¾¸ë¯¸ê¸°</h1>
    <div class="card" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <div class="pill-soft">í¬ì¸íŠ¸: <span th:text="${user.points}">0</span></div>
        <div class="pill-soft">ì—°ì† í’€ì´: <span th:text="${user.streak}">0</span>ì¼</div>
    </div>

    <div class="card" style="margin-top:12px;">
        <h3 style="margin:0 0 8px;">ì•„ë°”íƒ€ ì„ íƒ</h3>
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
            <div id="avatarPreview" class="pill-soft" style="font-size:22px; padding:10px 14px;"
                 th:text="${user.avatar != null ? user.avatar : 'ğŸ§‘'}">ğŸ§‘</div>
            <div style="color:#6b7280; font-size:13px;">ë³´ìœ í•œ ì•„ë°”íƒ€ëŠ” í¬ì¸íŠ¸ ì°¨ê° ì—†ì´ ììœ ë¡­ê²Œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </div>
        <form th:action="@{/profile/customize/avatar}" method="post" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;" id="avatarForm">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <label style="display:flex; flex-direction:column; gap:4px;">
                <span style="font-size:13px; color:#6b7280;">ì•„ë°”íƒ€</span>
                <select name="avatar" id="avatarSelect" style="min-width:220px; padding:10px; border:1px solid #d1d5db; border-radius:10px;">
                    <option th:each="opt : ${avatarOptions}"
                            th:value="${opt.value()}"
                            th:data-cost="${opt.cost()}"
                            th:selected="${user.avatar != null ? user.avatar == opt.value() : opt.value() == 'ğŸ§‘'}"
                            th:text="|${opt.value()} ${opt.label()} (${opt.cost()}P)|">
                        ğŸ§‘ ê¸°ë³¸ (0P)
                    </option>
                </select>
            </label>
            <div id="avatarCostInfo" class="pill-soft" style="color:#111827;">0P</div>
            <button class="btn btn-outline" type="submit" style="padding:10px 14px;">ì¥ì°© / êµ¬ë§¤</button>
        </form>
    </div>

    <div class="card">
        <h3 style="margin:0 0 8px;">ë°°ë„ˆ ì„ íƒ</h3>
        <div id="bannerPreview" class="card" style="padding:12px; color:#fff; margin-bottom:10px;"
             th:attr="data-banner=${user.banner != null ? user.banner : 'sunrise'}">
            <div style="font-weight:700;">ë°°ë„ˆ ë¯¸ë¦¬ë³´ê¸°</div>
            <div style="font-size:13px; color:#f1f5f9;">ì„ íƒí•œ ë°°ë„ˆê°€ ì—¬ê¸°ì— ì ìš©ë©ë‹ˆë‹¤.</div>
        </div>
        <form th:action="@{/profile/customize/banner}" method="post"
              style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;" id="bannerForm">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <label style="display:flex; flex-direction:column; gap:4px;">
                <span style="font-size:13px; color:#6b7280;">ë°°ë„ˆ</span>
                <select name="banner" id="bannerSelect" style="min-width:220px; padding:10px; border:1px solid #d1d5db; border-radius:10px;">
                    <option th:each="opt : ${bannerOptions}"
                            th:value="${opt.value()}"
                            th:data-cost="${opt.cost()}"
                            th:data-gradient="${opt.gradient()}"
                            th:selected="${user.banner != null ? user.banner == opt.value() : opt.value() == 'sunrise'}"
                            th:text="|${opt.label()} (${opt.cost()}P)|">
                        Sunrise (10P)
                    </option>
                </select>
            </label>
            <div id="bannerCostInfo" class="pill-soft" style="color:#111827;">0P</div>
            <button class="btn btn-outline" type="submit" style="padding:10px 14px;">ì¥ì°© / êµ¬ë§¤</button>
        </form>
    </div>

    <div class="card">
        <h3 style="margin:0 0 8px;">í’€ì´ íˆìŠ¤í† ë¦¬</h3>
        <p style="margin:0 0 8px; color:#6b7280; font-size:13px;">ë¬¸ì œë¥¼ í‘¼ ë‚ ì§œê°€ ìƒ‰ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
        <div id="solveHeatmap" style="display:grid; grid-template-columns:repeat(7, minmax(24px, 1fr)); gap:4px; max-width:420px;"></div>
    </div>
</div>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', ()=>{
        const ownedAvatars = new Set(/*[[${ownedAvatars}]]*/ []);
        const ownedBanners = new Set(/*[[${ownedBanners}]]*/ []);
        const avatarSelect = document.getElementById('avatarSelect');
        const avatarPreview = document.getElementById('avatarPreview');
        const avatarCostInfo = document.getElementById('avatarCostInfo');
        const bannerSelect = document.getElementById('bannerSelect');
        const bannerPreview = document.getElementById('bannerPreview');
        const bannerCostInfo = document.getElementById('bannerCostInfo');

        const updateAvatarUI = () => {
            if (!avatarSelect) return;
            const opt = avatarSelect.selectedOptions[0];
            const value = opt?.value || 'ğŸ§‘';
            const cost = parseInt(opt?.dataset.cost || '0', 10);
            const owned = ownedAvatars.has(value) || cost === 0;
            if (avatarPreview) avatarPreview.textContent = value;
            if (avatarCostInfo) {
                avatarCostInfo.textContent = owned ? 'ë³´ìœ ' : `${cost}P`;
                avatarCostInfo.style.background = owned ? '#d1fae5' : '#fff7ed';
                avatarCostInfo.style.color = owned ? '#065f46' : '#9a3412';
            }
        };

        const updateBannerUI = () => {
            if (!bannerSelect || !bannerPreview) return;
            const opt = bannerSelect.selectedOptions[0];
            const value = opt?.value || 'sunrise';
            const cost = parseInt(opt?.dataset.cost || '0', 10);
            const gradient = opt?.dataset.gradient || '';
            const owned = ownedBanners.has(value) || cost === 0;
            bannerPreview.style.background = gradient || 'linear-gradient(90deg,#f59e0b,#f97316)';
            bannerCostInfo.textContent = owned ? 'ë³´ìœ ' : `${cost}P`;
            bannerCostInfo.style.background = owned ? '#d1fae5' : '#fff7ed';
            bannerCostInfo.style.color = owned ? '#065f46' : '#9a3412';
        };

        avatarSelect?.addEventListener('change', updateAvatarUI);
        bannerSelect?.addEventListener('change', updateBannerUI);
        updateAvatarUI();
        updateBannerUI();
        // íˆíŠ¸ë§µ
        const heatmap = document.getElementById('solveHeatmap');
        if (heatmap) {
            const raw = localStorage.getItem('solveDates') || '[]';
            let dates = [];
            try { dates = JSON.parse(raw); } catch(e){}
            const set = new Set(dates);
            const today = new Date();
            for(let i=0;i<49;i++){
                const cell = document.createElement('div');
                cell.style.border = '1px solid #e5e7eb';
                cell.style.borderRadius = '6px';
                cell.style.padding = '14px 0';
                const d = new Date();
                d.setDate(today.getDate() - (48 - i));
                const key = d.toISOString().slice(0,10);
                const active = set.has(key);
                cell.style.background = active ? '#a7f3d0' : '#f8fafc';
                heatmap.appendChild(cell);
            }
        }
    });
</script>
</body>
</html>
