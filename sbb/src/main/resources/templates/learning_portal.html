<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="layout :: layout(~{::body})">
<body>
<div class="page-card">
        <div class="page-header">
            <div>
                <div class="pill-soft">학습 포털</div>
                <h1 class="page-title">나의 수업, 과제, 공지 한눈에</h1>
                <p class="muted">그룹(수업)에서 올라온 과제와 공지사항을 한 곳에서 확인하세요.</p>
            </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:flex-start; margin-top:8px; margin-bottom:6px;">
            <a class="btn" href="/groups">내 그룹 보기</a>
        </div>
        </div>

    <div class="card-grid" style="display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr));">
        <div class="card portal-tile" style="min-height:260px; display:flex; flex-direction:column; background:linear-gradient(135deg,#eef2ff,#e0f2fe);">
            <div class="tile-head">
                <div class="title-md">내 그룹</div>
                <span class="pill-soft" th:text="${#lists.size(memberships)} + '개'">0개</span>
            </div>
            <div class="tile-body" style="overflow:auto; flex:1;">
                <div th:if="${#lists.isEmpty(memberships)}" class="muted">아직 참여한 그룹이 없습니다.</div>
                <div th:each="m : ${memberships}" class="portal-item" data-title="내 그룹" th:data-body="${m.group.name}" th:data-url="@{'/groups/' + ${m.group.id}}">
                    <div class="item-title" th:text="${m.group.name}">수업명</div>
                    <div class="item-meta" th:text="${m.role == 'OWNER' ? '담당자' : '수강생'}">역할</div>
                    <div class="item-meta" th:text="${m.group.joinCode != null ? '코드 ' + m.group.joinCode : ''}">코드</div>
                </div>
            </div>
        </div>
        <div class="card portal-tile" style="min-height:260px; display:flex; flex-direction:column; background:linear-gradient(135deg,#ecfdf3,#e0f7e9);">
            <div class="tile-head">
                <div class="title-md">과제</div>
                <span class="pill-soft" th:text="${taskCount} + '건'">0건</span>
            </div>
            <div class="tile-body" style="overflow:auto; flex:1;">
                <div th:if="${#lists.isEmpty(taskSections)}" class="muted">등록된 과제가 없습니다.</div>
                <div th:each="section, idx : ${taskSections}" class="section-block" th:data-section="${'task-' + idx.index}">
                    <button type="button" class="section-toggle">
                        <div>
                            <div class="item-title" th:text="${section.group.name}">그룹명</div>
                            <div class="item-meta" th:text="${#lists.size(section.tasks)} + '건'">0건</div>
                        </div>
                        <span class="chevron">⌄</span>
                    </button>
                    <div class="section-body">
                        <div th:if="${#lists.isEmpty(section.tasks)}" class="muted">과제가 없습니다.</div>
                        <div th:each="item : ${section.tasks}" class="portal-item"
                             th:data-title="${section.group.name}"
                             th:data-body="${item.title}"
                             th:data-url="@{'/groups/' + ${section.group.id}}"
                             th:data-extra="${item.dueDate != null ? '마감 ' + item.dueDate : '마감일 없음'}">
                            <div class="item-title" th:text="${item.title}">과제 제목</div>
                            <div class="item-meta" th:text="${section.group.name}">그룹</div>
                            <div class="item-meta" th:text="${item.dueDate != null ? '마감: ' + item.dueDate : '마감일 없음'}">마감</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card portal-tile" style="min-height:260px; display:flex; flex-direction:column; background:linear-gradient(135deg,#fff7ed,#fffbeb);">
            <div class="tile-head">
                <div class="title-md">공지사항</div>
                <span class="pill-soft" th:text="${noticeCount} + '건'">0건</span>
            </div>
            <div class="tile-body" style="overflow:auto; flex:1;">
                <div th:if="${#lists.isEmpty(noticeSections)}" class="muted">새 공지가 없습니다.</div>
                <div th:each="section, idx : ${noticeSections}" class="section-block" th:data-section="${'notice-' + idx.index}">
                    <button type="button" class="section-toggle">
                        <div>
                            <div class="item-title" th:text="${section.group.name}">그룹명</div>
                            <div class="item-meta" th:text="${#lists.size(section.notices)} + '건'">0건</div>
                        </div>
                        <span class="chevron">⌄</span>
                    </button>
                    <div class="section-body">
                        <div th:if="${#lists.isEmpty(section.notices)}" class="muted">공지사항이 없습니다.</div>
                        <div th:each="item : ${section.notices}" class="portal-item"
                             th:data-title="${section.group.name}"
                             th:data-body="${item.title}"
                             th:data-url="@{'/groups/' + ${section.group.id}}"
                             th:data-extra="${item.createdAt != null ? #temporals.format(item.createdAt, 'yyyy.MM.dd HH:mm') : ''}">
                            <div class="item-title" th:text="${item.title}">공지 제목</div>
                            <div class="item-meta" th:text="${section.group.name}">그룹</div>
                            <div class="item-meta" th:text="${item.createdAt != null ? #temporals.format(item.createdAt, 'yyyy.MM.dd HH:mm') : ''}">작성일</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="portalModal" class="portal-modal" hidden>
    <div class="portal-backdrop"></div>
    <div class="portal-dialog">
        <div class="portal-dialog__head">
            <div class="title-md" id="modalTitle">제목</div>
            <button type="button" class="btn btn-outline btn-sm" id="modalClose">닫기</button>
        </div>
        <div class="portal-dialog__body">
            <div class="muted" id="modalExtra"></div>
            <div style="margin-top:8px; font-weight:600;" id="modalBody"></div>
        </div>
        <div class="portal-dialog__footer">
            <a id="modalLink" class="btn" href="#">상세 보기</a>
        </div>
    </div>
</div>
<style>
    .portal-tile .item-title { font-weight:700; color:#0f172a; font-size:14px; }
    .portal-tile .item-meta { color:#6b7280; font-size:12px; margin-top:2px; }
    .portal-item { padding:10px; border:1px solid #e5e7eb; border-radius:10px; background:#f9fafb; cursor:pointer; }
    .portal-item + .portal-item { margin-top:8px; }
    .section-block { border:1px solid #e5e7eb; border-radius:10px; background:#f8fafc; margin-bottom:10px; }
    .section-toggle { width:100%; text-align:left; border:none; background:transparent; padding:10px 12px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
    .section-body { padding:0 12px 12px 12px; display:none; }
    .section-block.is-open .section-body { display:block; }
    .section-block .chevron { transition: transform 0.2s ease; }
    .section-block.is-open .chevron { transform: rotate(180deg); }
    .tile-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .tile-body { padding:2px; max-height:320px; overflow:auto; }
    .portal-modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:9999; }
    .portal-modal[hidden] { display:none; }
    .portal-backdrop { position:absolute; inset:0; background:rgba(0,0,0,0.4); }
    .portal-dialog { position:relative; background:#fff; padding:16px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.18); width:min(420px, 90vw); }
    .portal-dialog__head { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .portal-dialog__body { margin-top:10px; font-size:14px; }
    .portal-dialog__footer { margin-top:12px; text-align:right; }
</style>
<script>
    document.addEventListener('DOMContentLoaded', ()=>{
        const modal = document.getElementById('portalModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalExtra = document.getElementById('modalExtra');
        const modalLink = document.getElementById('modalLink');
        const closeBtn = document.getElementById('modalClose');
        const hide = ()=> modal.setAttribute('hidden','hidden');
        const show = (title, body, extra, url)=>{
            modalTitle.textContent = title || '상세';
            modalBody.textContent = body || '';
            modalExtra.textContent = extra || '';
            modalLink.href = url || '#';
            modal.removeAttribute('hidden');
        };
        closeBtn?.addEventListener('click', hide);
        modal?.querySelector('.portal-backdrop')?.addEventListener('click', hide);
        document.querySelectorAll('.portal-item').forEach(item=>{
            item.addEventListener('click', ()=>{
                show(item.dataset.title, item.dataset.body, item.dataset.extra, item.dataset.url);
            });
        });

        document.querySelectorAll('.section-block').forEach(block=>{
            const toggle = block.querySelector('.section-toggle');
            const targetBody = block.querySelector('.section-body');
            const sync = () => {
                if (block.classList.contains('is-open')) {
                    targetBody?.style.setProperty('display','block');
                } else {
                    targetBody?.style.setProperty('display','none');
                }
            };
            sync();
            toggle?.addEventListener('click', ()=>{
                block.classList.toggle('is-open');
                sync();
            });
        });
    });
</script>
</body>
</html>
