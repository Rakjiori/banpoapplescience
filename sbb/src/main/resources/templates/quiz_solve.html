<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="layout :: layout(~{::body})">
<body>
<style>
    .question-sheet {
        position:fixed;
        right:0;
        top:0;
        height:100vh;
        width:360px;
        max-width:90vw;
        background:#fff;
        box-shadow:-8px 0 30px rgba(0,0,0,0.18);
        transform:translateX(100%);
        transition:transform 0.25s ease;
        z-index:95;
        display:flex;
        flex-direction:column;
    }
    .question-sheet.open { transform:translateX(0); }
    .question-sheet__header {
        padding:16px 18px;
        border-bottom:1px solid #e5e7eb;
        display:flex;
        justify-content:space-between;
        align-items:center;
    }
    .question-sheet__body {
        padding:16px 18px;
        overflow:auto;
        flex:1;
    }
    .question-sheet__card {
        border:1px solid #e5e7eb;
        border-radius:12px;
        padding:10px 12px;
        margin-bottom:10px;
        cursor:pointer;
        transition:border-color 0.2s ease;
    }
    .question-sheet__card:hover { border-color:#111827; }
    .sheet-toggle-btn {
        position:fixed;
        right:18px;
        bottom:18px;
        z-index:96;
        border:none;
        border-radius:999px;
        background:#111827;
        color:#fff;
        padding:12px 16px;
        font-weight:700;
        box-shadow:0 10px 30px rgba(0,0,0,0.25);
        cursor:pointer;
    }
    @media(max-width:768px){
        .question-sheet { width:100%; }
    }
</style>
<div>

    <h1 class="page-title">í€´ì¦ˆ í’€ê¸°</h1>

    <div class="card" th:if="${question != null}">
        <div class="question-header-banner">
            <div class="question-number-box">
                <span th:text="'ë¬¸ì œ ' + ${question.numberTag}">ë¬¸ì œ 1</span>
            </div>
            <span class="question-tag">ì°¨ë¶„íˆ í’€ì–´ë´ìš”</span>
        </div>

        <p style="font-size:17px; font-weight:600; margin-top:12px; white-space:pre-wrap;"
           th:text="${question.questionText}">ë¬¸ì œ ë‚´ìš©</p>

        <form id="quizSolveForm"
              th:action="@{'/quiz/solve/' + ${question.id}}"
              method="post"
              style="margin-top:18px;">

            <input type="hidden" name="folderId"
                   th:value="${selectedFolder != null ? selectedFolder.id : (question.folder != null ? question.folder.id : null)}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

            <div th:if="${choiceList != null && !#lists.isEmpty(choiceList)}">
                <p style="font-size:14px; color:#6b7280; margin-bottom:12px;">
                    ì›í•˜ëŠ” ë³´ê¸°ë¥¼ í´ë¦­í•´ ì£¼ì„¸ìš”.
                </p>
                <div class="choice-vertical">
                    <button type="button"
                            class="choice-option"
                            th:each="choice : ${choiceList}"
                            th:data-value="${choice.value}">
                        <span class="choice-index"
                              th:text="${choice.number != null ? choice.number + '.' : ''}"></span>
                        <span class="choice-text"
                              th:text="${choice.text}"></span>
                    </button>
                </div>
                <input type="hidden" id="selectedAnswer" name="answer">
            </div>

            <div th:if="${choiceList == null || #lists.isEmpty(choiceList)}"
                 style="margin-top:12px;">
                <label for="answerText"
                       style="font-size:14px; font-weight:500;">ì£¼ê´€ì‹ ë‹µì„ ì…ë ¥í•´ ì£¼ì„¸ìš”</label>
                <input id="answerText" type="text" name="answer" required>
            </div>

            <button type="submit" class="btn" style="margin-top:14px; width:100%;">
                 ì •ë‹µ í™•ì¸
            </button>
        </form>
    </div>

    <div th:if="${discussionGroupId != null and discussionQuestionId != null}"
         class="card"
         style="margin-top:16px; padding:12px; background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px;"
         th:attr="data-group-id=${discussionGroupId}, data-question-id=${discussionQuestionId}"
         data-role="group-discussion">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="font-weight:700;">ê·¸ë£¹ í† ë¡ </div>
            <small style="color:#6b7280;">ë²„íŠ¼ ì—†ì´ ë°”ë¡œ ëŒ“ê¸€ì„ ë‚¨ê¸¸ ìˆ˜ ìˆì–´ìš”.</small>
        </div>
        <div data-role="list" style="display:flex; flex-direction:column; gap:8px;"></div>
        <div data-role="empty" style="color:#6b7280;">ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ ë³´ì„¸ìš”.</div>
        <form data-role="form" style="display:flex; gap:8px; margin-top:10px; align-items:flex-start;">
            <textarea data-role="input"
                      rows="2"
                      style="flex:1; padding:10px; border:1px solid #d1d5db; border-radius:10px; resize:vertical; font-family:'Noto Sans KR','Segoe UI',sans-serif;"
                      placeholder="ìƒê°ì„ ê³µìœ í•´ ë³´ì„¸ìš”"></textarea>
            <button type="submit" class="btn" style="padding:10px 14px; flex:0 0 auto;">ë“±ë¡</button>
        </form>
        <div data-role="error" style="display:none; margin-top:6px; color:#dc2626; font-size:13px;"></div>
    </div>

    <div th:if="${discussionGroupId == null or discussionQuestionId == null}"
         style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start;">
        <a th:href="@{/quiz/discussion/{id}(id=${question.id})}"
           class="btn btn-outline">í† ë¡ </a>
    </div>

    <div class="question-sheet" id="questionSheet">
        <div class="question-sheet__header">
            <div>
                <strong>ì „ì²´ ë¬¸ì œ</strong>
                <p style="margin:4px 0 0; font-size:13px; color:#6b7280;">
                    ì´ <span th:text="${#lists.size(questionList)}">0</span>ê°œ
                </p>
            </div>
            <button type="button" class="btn btn-outline" id="closeSheetBtn" style="padding:6px 12px;">ë‹«ê¸°</button>
        </div>
        <div class="question-sheet__body">
            <div th:if="${#lists.isEmpty(questionList)}"
                 style="text-align:center; color:#9ca3af;">
                ì•„ì§ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
            <div th:each="item : ${questionList}"
                 class="question-sheet__card"
                 th:data-link="${selectedFolder != null} ? @{/quiz/solve/{id}(id=${item.id}, folderId=${selectedFolder.id})} : @{/quiz/solve/{id}(id=${item.id})}">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <strong th:text="'ë¬¸ì œ ' + ${item.numberTag}">ë¬¸ì œ</strong>
                    <span style="font-size:12px; color:#6b7280;"
                          th:text="${item.createdAtFormatted}"></span>
                </div>
                <p style="margin:6px 0 0; font-size:13px; color:#4b5563; white-space:pre-wrap;"
                   th:text="${item.questionText}"></p>
            </div>
        </div>
    </div>

</div>

<script th:if="${choiceList != null && !#lists.isEmpty(choiceList)}">
    document.addEventListener('DOMContentLoaded', function () {
        const buttons = document.querySelectorAll('.choice-option');
        const hiddenInput = document.getElementById('selectedAnswer');
        const form = document.getElementById('quizSolveForm');

        buttons.forEach((btn) => {
            btn.addEventListener('click', () => {
                buttons.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                hiddenInput.value = btn.dataset.value;
            });
        });

        form.addEventListener('submit', (e) => {
            if (!hiddenInput.value || !hiddenInput.value.trim()) {
                e.preventDefault();
                alert('ë³´ê¸°ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
            }
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const sheet = document.getElementById('questionSheet');
        const toggle = document.getElementById('questionSheetToggle');
        const closeBtn = document.getElementById('closeSheetBtn');
        if (sheet && toggle) {
            const toggleSheet = () => sheet.classList.toggle('open');
            toggle.addEventListener('click', toggleSheet);
            if (closeBtn) closeBtn.addEventListener('click', toggleSheet);
        }

        document.querySelectorAll('.question-sheet__card').forEach(card => {
            card.addEventListener('click', () => {
                const link = card.dataset.link;
                if (link) window.location.href = link;
            });
        });

        // ê·¸ë£¹ ì¸ë¼ì¸ í† ë¡  (ê·¸ë£¹ í’€ ë•Œë§Œ ì¡´ì¬)
        const discussionCard = document.querySelector('[data-role="group-discussion"]');
        if (discussionCard) {
            const groupId = discussionCard.dataset.groupId;
            const questionId = discussionCard.dataset.questionId;
            const listEl = discussionCard.querySelector('[data-role="list"]');
            const emptyEl = discussionCard.querySelector('[data-role="empty"]');
            const formEl = discussionCard.querySelector('[data-role="form"]');
            const inputEl = discussionCard.querySelector('[data-role="input"]');
            const errorEl = discussionCard.querySelector('[data-role="error"]');
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.content || '';
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';

            const myName = document.querySelector('meta[name=\"author\"]')?.content || '';
            const render = (items = []) => {
                if (!listEl || !emptyEl) return;
                listEl.innerHTML = '';
                if (!items.length) {
                    emptyEl.style.display = 'block';
                    return;
                }
                emptyEl.style.display = 'none';
                items.forEach(item => {
                    const isMine = myName && item.username === myName;
                    const wrapper = document.createElement('div');
                    wrapper.style.cssText = 'display:flex; gap:8px; justify-content:' + (isMine ? 'flex-end' : 'flex-start') + ';';

                    const bubble = document.createElement('div');
                    bubble.style.cssText = [
                        'max-width:76%',
                        'padding:8px 10px',
                        'border-radius:12px',
                        isMine ? 'border:1px solid #c7d2fe; background:#eef2ff;' : 'border:1px solid #e5e7eb; background:#fff;',
                        'font-family:"Noto Sans KR","Segoe UI",sans-serif',
                        'box-shadow:0 6px 12px rgba(0,0,0,0.05)'
                    ].join(';');

                    const avatarIcon = (item.avatar || '').trim() || localStorage.getItem('profileAvatar') || 'ğŸ˜Š';
                    const avatar = document.createElement('div');
                    avatar.style.cssText = 'width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:#f3f4f6;font-size:20px;';
                    avatar.textContent = avatarIcon;

                    bubble.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                            <strong style="font-size:13px; color:${isMine ? '#3730a3' : '#111827'};">${item.username || 'user'}</strong>
                            <span style="color:#9ca3af; font-size:11px;">${item.createdAt || ''}</span>
                        </div>
                        <div style="margin-top:4px; white-space:pre-wrap; color:#374151; font-size:14px; line-height:1.45;">${item.content || ''}</div>
                    `;

                    if (isMine) {
                        wrapper.append(bubble, avatar);
                    } else {
                        wrapper.append(avatar, bubble);
                    }
                    listEl.appendChild(wrapper);
                });
            };

            const load = async () => {
                if (!groupId || !questionId) return;
                if (listEl) listEl.innerHTML = '<div style="color:#6b7280;">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
                if (errorEl) {
                    errorEl.style.display = 'none';
                    errorEl.textContent = '';
                }
                try {
                    const res = await fetch(`/groups/${groupId}/discussion/${questionId}/list`, {
                        headers: csrfToken ? { [csrfHeader]: csrfToken } : {}
                    });
                    if (!res.ok) throw new Error();
                    const data = await res.json();
                    render(Array.isArray(data) ? data : []);
                } catch (e) {
                    if (errorEl) {
                        errorEl.style.display = 'block';
                        errorEl.textContent = 'ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
                    }
                    render([]);
                }
            };

            if (formEl && inputEl) {
                formEl.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const content = inputEl.value.trim();
                    if (!content) return;
                    const body = new URLSearchParams();
                    body.append('content', content);
                    const headers = { 'Content-Type': 'application/x-www-form-urlencoded' };
                    if (csrfToken) headers[csrfHeader] = csrfToken;
                    try {
                        const res = await fetch(`/groups/${groupId}/discussion/${questionId}/add`, {
                            method: 'POST',
                            headers,
                            body: body.toString()
                        });
                        if (!res.ok) throw new Error();
                        inputEl.value = '';
                        await load();
                    } catch (err) {
                        if (errorEl) {
                            errorEl.style.display = 'block';
                            errorEl.textContent = 'ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                        }
                    }
                });
            }

            load();
        }
    });
</script>
</body>
</html>
