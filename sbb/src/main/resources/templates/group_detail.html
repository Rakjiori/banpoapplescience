<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="layout :: layout(~{::body})">
<body>
<div>
    <a href="/groups" class="btn btn-outline" style="margin-bottom:10px;">← 그룹 목록으로</a>
    <h1 class="page-title" th:text="${group.name}">그룹</h1>
    <p style="margin-top:-6px; color:#6b7280;">참여 코드: <span style="font-weight:700;" th:text="${group.joinCode}"></span></p>

    <div class="card" style="margin-bottom:12px;">
        <h4 style="margin:0 0 8px;">공유된 문제</h4>
        <div th:if="${#lists.isEmpty(sharedQuestions)}" style="color:#6b7280;">아직 공유된 문제가 없습니다.</div>
        <div th:each="item : ${sharedQuestions}"
             style="padding:12px; border:1px solid #e5e7eb; border-radius:12px; margin-bottom:10px; background:#f8fafc;">
            <div style="font-weight:600; white-space:pre-wrap;" th:text="${item.question.questionText}">문제</div>
            <div style="color:#6b7280; font-size:13px; margin-top:6px; display:flex; justify-content:space-between; align-items:center;">
                <span>
                    공유자: <span th:text="${item.sharedBy.username}"></span>
                    · <span th:text="${#temporals.format(item.sharedAt, 'yyyy.MM.dd HH:mm')}"></span>
                </span>
                <form th:action="@{/groups/use-shared/{id}(id=${item.id})}" method="post" style="margin:0; display:flex; flex-wrap:wrap; gap:6px; align-items:center;">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button type="submit" class="btn btn-outline" style="padding:6px 12px;">풀기</button>
                    <button th:if="${isOwner}"
                            th:formaction="@{/groups/shared/{id}/delete(id=${item.id})}"
                            formmethod="post"
                            class="btn btn-outline"
                            style="padding:6px 12px;"
                            onclick="return confirm('공유된 문제를 삭제할까요?');">삭제</button>
                </form>
            </div>

        </div>
    </div>

    <div class="card" style="margin-bottom:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;"
             id="toggleMembers">
            <h4 style="margin:0;">멤버 목록</h4>
            <span aria-hidden="true">▼</span>
        </div>
        <div id="membersPanel" style="margin-top:8px;">
            <div th:if="${#lists.isEmpty(members)}" style="color:#6b7280;">멤버가 없습니다.</div>
            <div th:each="m : ${members}"
                 style="display:flex; justify-content:space-between; align-items:center; padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px; margin-bottom:6px;">
                <div>
                    <div style="font-weight:700;" th:text="${m.user.username}">username</div>
                    <div style="color:#9ca3af; font-size:12px;">
                        <span th:text="${m.role}">ROLE</span>
                        · <span th:text="${#temporals.format(m.joinedAt, 'yyyy.MM.dd HH:mm')}">date</span>
                    </div>
                </div>
                <form th:if="${isOwner and m.user.id != group.owner.id}"
                      th:action="@{/groups/{groupId}/members/{memberId}/remove(groupId=${group.id},memberId=${m.id})}"
                      method="post"
                      onsubmit="return confirm('해당 멤버를 추방할까요?');">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button type="submit" class="btn btn-outline" style="padding:4px 8px;">삭제</button>
                </form>
            </div>
        </div>
    </div>

    <div class="card" style="margin-bottom:12px;" th:if="${isOwner}">
        <div style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;"
             id="toggleInvite">
            <h4 style="margin:0;">친구 초대</h4>
            <span aria-hidden="true">▼</span>
        </div>
        <div id="invitePanel" style="margin-top:8px;">
            <form th:action="@{/groups/{id}/members/invite(id=${group.id})}" method="post"
                  style="display:flex; flex-direction:column; gap:8px;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <div style="display:flex; flex-direction:column; gap:6px;">
                    <div th:each="fr : ${friends}"
                         th:if="${memberUserIds == null or !memberUserIds.contains(fr.to.id)}"
                         style="display:flex; align-items:center; gap:8px; padding:6px 8px; border:1px solid #e5e7eb; border-radius:8px;">
                        <input type="checkbox" name="friendIds" th:value="${fr.id}">
                        <div>
                            <div style="font-weight:700;" th:text="${fr.to.username}">friend</div>
                            <div style="font-size:12px; color:#9ca3af;">
                                포인트: <span th:text="${fr.to.points}">0</span> · 연속 풀이: <span th:text="${fr.to.streak}">0</span>
                            </div>
                        </div>
                    </div>
                    <div th:if="${#lists.isEmpty(friends)}" style="color:#6b7280;">초대할 친구가 없습니다.</div>
                </div>
                <button type="submit" class="btn" style="padding:8px 12px; align-self:flex-end;">초대 보내기</button>
            </form>
        </div>
    </div>

    <form th:action="@{/groups/{id}/leave(id=${group.id})}" method="post" style="margin-top:10px;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        <button type="submit" class="btn btn-outline">그룹 나가기</button>
    </form>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const toggleMembers = document.getElementById('toggleMembers');
        const membersPanel = document.getElementById('membersPanel');
        const toggleInvite = document.getElementById('toggleInvite');
        const invitePanel = document.getElementById('invitePanel');
        if (membersPanel) membersPanel.style.display = 'none';
        if (invitePanel) invitePanel.style.display = 'none';
        if (toggleMembers && membersPanel) {
            toggleMembers.addEventListener('click', () => {
                const isHidden = membersPanel.style.display === 'none';
                membersPanel.style.display = isHidden ? 'block' : 'none';
            });
        }
        if (toggleInvite && invitePanel) {
            toggleInvite.addEventListener('click', () => {
                const isHidden = invitePanel.style.display === 'none';
                invitePanel.style.display = isHidden ? 'block' : 'none';
            });
        }
    });
</script>
</body>
</html>
