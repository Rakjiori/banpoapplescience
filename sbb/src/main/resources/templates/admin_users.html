<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="layout :: layout(~{::body})">
<body>
<div class="page-card">
    <div class="page-header">
        <div>
            <div class="pill">관리자/루트</div>
            <h1 class="page-title">계정 현황 & 권한 관리</h1>
            <p class="muted">학교/학년별 가입 계정을 확인하고, 루트는 관리자 권한을 부여/회수할 수 있습니다.</p>
        </div>
        <div class="pill-soft">접속 계정: <span th:text="${rootUsername}">root</span></div>
    </div>

    <div class="card" style="margin-bottom:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <input type="text" id="userSearch" placeholder="아이디, 이름, 학교, 학년 검색" style="flex:1; min-width:240px; padding:10px; border:1px solid #e5e7eb; border-radius:10px;">
        <select id="roleFilter" style="padding:10px; border:1px solid #e5e7eb; border-radius:10px;">
            <option value="admin-only" selected>관리자/루트만 보기</option>
            <option value="all">전체 보기</option>
            <option value="root-only">루트만 보기</option>
        </select>
    </div>

    <div th:if="${message}" class="alert alert-success" style="margin-bottom:12px;">
        <span th:text="${message}"></span>
    </div>
    <div th:if="${error}" class="alert alert-danger" style="margin-bottom:12px;">
        <span th:text="${error}"></span>
    </div>

    <div class="card" style="padding:0;">
        <div style="max-height:420px; overflow:auto;">
            <div class="table-row" style="display:grid; grid-template-columns: 80px 160px 180px 140px 140px 240px; align-items:center; gap:8px; padding:10px; border-bottom:1px solid #e5e7eb; font-weight:600; background:#f8fafc;">
                <div>#</div>
                <div>아이디</div>
                <div>학교</div>
                <div>학년</div>
                <div>이름</div>
                <div>권한 / 관리</div>
            </div>
            <div class="table-row user-row"
                 th:each="u, stat : ${users}"
                 th:data-role="${u.role}"
                 th:data-text="${(u.id + ' ' + u.username + ' ' + (u.fullName != null ? u.fullName : '') + ' ' + (u.schoolName != null ? u.schoolName : '') + ' ' + (u.grade != null ? u.grade : '')).toLowerCase()}"
                 style="display:grid; grid-template-columns: 80px 160px 180px 140px 140px 240px; align-items:center; gap:8px; padding:10px; border-bottom:1px solid #f1f5f9;">
                <div class="pill-soft" th:text="${stat.index + 1}">1</div>
                <div class="title-md" th:text="${u.username}">username</div>
                <div class="muted" th:text="${u.schoolName != null ? u.schoolName : '-'}">학교</div>
                <div class="muted" th:text="${u.grade != null ? u.grade : '-'}">학년</div>
                <div class="muted" th:text="${u.fullName != null ? u.fullName : ''}">이름</div>
                <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                    <span class="pill" th:if="${u.role == 'ROLE_ADMIN'}" th:text="${u.role}">ROLE_ADMIN</span>
                    <span class="pill" th:if="${u.role == 'ROLE_ROOT'}" th:text="${u.role}">ROLE_ROOT</span>
                    <form th:if="${isRoot and u.role != 'ROLE_ROOT' and u.role != 'ROLE_ADMIN'}"
                          th:action="@{/admin/users/{id}/promote(id=${u.id})}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <button type="submit" class="btn" style="padding:6px 10px;">관리자로 지정</button>
                    </form>
                    <form th:if="${isRoot and u.role == 'ROLE_ADMIN'}"
                          th:action="@{/admin/users/{id}/revoke(id=${u.id})}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <button type="submit" class="btn btn-outline" style="padding:6px 10px;"
                                onclick="return confirm('관리자 권한을 해제할까요?');">관리자 해제</button>
                    </form>
                    <span th:if="${u.role == 'ROLE_ROOT'}" class="pill-soft">루트</span>
                    <form th:if="${u.role != 'ROLE_ROOT'}"
                          th:action="@{/admin/users/{id}/delete(id=${u.id})}" method="post"
                          onsubmit="return confirm('계정을 삭제할까요? 되돌릴 수 없습니다.');">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <button type="submit" class="btn btn-outline" style="padding:6px 10px; color:#b91c1c; border-color:#fecdd3;">삭제</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="card-grid" style="margin-top:18px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));">
        <div class="card">
            <div class="title-md" style="margin-bottom:8px;">학교별 계정</div>
            <div class="muted" th:if="${#maps.isEmpty(bySchool)}">학교 정보가 있는 계정이 없습니다.</div>
            <div th:each="entry : ${bySchool}">
                <div class="pill-soft" th:text="${entry.key}">학교명</div>
                <ul class="muted" style="margin:6px 0 12px 14px; padding:0; list-style:disc;">
                    <li th:each="u : ${entry.value}">
                        <span th:text="${u.fullName}">이름</span>
                        (<span th:text="${u.username}">id</span>)
                        <span th:text="${u.grade != null ? ' / ' + u.grade : ''}"></span>
                        <span th:text="${u.role == 'ROLE_ADMIN' ? ' - 관리자' : (u.role == 'ROLE_ROOT' ? ' - 루트' : '')}"></span>
                    </li>
                </ul>
            </div>
        </div>
        <div class="card">
            <div class="title-md" style="margin-bottom:8px;">학년별 계정</div>
            <div class="muted" th:if="${#maps.isEmpty(byGrade)}">학년 정보가 있는 계정이 없습니다.</div>
            <div th:each="entry : ${byGrade}">
                <div class="pill-soft" th:text="${entry.key}">학년</div>
                <ul class="muted" style="margin:6px 0 12px 14px; padding:0; list-style:disc;">
                    <li th:each="u : ${entry.value}">
                        <span th:text="${u.fullName}">이름</span>
                        (<span th:text="${u.username}">id</span>)
                        <span th:text="${u.schoolName != null ? ' / ' + u.schoolName : ''}"></span>
                        <span th:text="${u.role == 'ROLE_ADMIN' ? ' - 관리자' : (u.role == 'ROLE_ROOT' ? ' - 루트' : '')}"></span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
</body>
<script>
    document.addEventListener('DOMContentLoaded', ()=>{
        const search = document.getElementById('userSearch');
        const filter = document.getElementById('roleFilter');
        const rows = Array.from(document.querySelectorAll('.user-row'));
        const apply = ()=>{
            const term = (search?.value || '').toLowerCase();
            const mode = filter?.value || 'admin-only';
            rows.forEach(r=>{
                const text = (r.dataset.text || '').toLowerCase();
                const role = r.dataset.role || '';
                let roleOk = true;
                if(mode === 'admin-only') roleOk = role === 'ROLE_ADMIN' || role === 'ROLE_ROOT';
                else if(mode === 'root-only') roleOk = role === 'ROLE_ROOT';
                if(term && !text.includes(term)) roleOk = false;
                r.style.display = roleOk ? 'grid' : 'none';
            });
        };
        search?.addEventListener('input', apply);
        filter?.addEventListener('change', apply);
        apply();
    });
</script>
</html>
