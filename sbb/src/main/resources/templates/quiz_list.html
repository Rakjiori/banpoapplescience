<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{layout :: layout(~{::body})}">
<body>
<style>
    .highlight-card {
        background: linear-gradient(135deg, #fef3c7, #fff7ed);
        border-radius: 18px;
        padding: 26px;
        box-shadow: 0 12px 30px rgba(0,0,0,0.08);
        margin-bottom: 22px;
    }
    .highlight-header {
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        margin-bottom:12px;
    }
    .highlight-pill {
        background:#1f2937;
        color:#fff;
        padding:4px 10px;
        border-radius:999px;
        font-size:12px;
        letter-spacing:0.06em;
        text-transform:uppercase;
    }
    .highlight-meta {
        color:#6b7280;
        font-size:13px;
        display:flex;
        gap:10px;
    }
    .choice-grid {
        display:flex;
        flex-direction:column;
        gap:10px;
        margin-top:14px;
    }
    .choice-chip {
        border:1px solid rgba(31,41,55,0.15);
        border-radius:12px;
        padding:12px 14px;
        background:#fff;
        display:flex;
        gap:10px;
        align-items:flex-start;
        cursor:pointer;
        transition:all 0.2s ease;
    }
    .choice-chip:hover {
        border-color:#111827;
    }
    .choice-chip.selected {
        border-color:#6366f1;
        background:#eef2ff;
    }
    .choice-chip.correct {
        border-color:#16a34a;
        background:#dcfce7;
    }
    .choice-chip.wrong {
        border-color:#dc2626;
        background:#fee2e2;
    }
    .check-panel {
        display:flex;
        gap:10px;
        margin-top:16px;
        flex-wrap:wrap;
    }
    .question-sheet-toggle {
        position:fixed;
        left:24px;
        bottom:24px;
        z-index:90;
        border:none;
        border-radius:999px;
        background:#111827;
        color:#fff;
        font-weight:600;
        padding:12px 20px;
        box-shadow:0 10px 30px rgba(0,0,0,0.25);
        cursor:pointer;
    }
    .question-sheet {
        position:fixed;
        left:0;
        bottom:0;
        width:380px;
        max-height:80vh;
        background:#fff;
        border-top-right-radius:24px;
        border-top-left-radius:0;
        box-shadow:0 20px 45px rgba(0,0,0,0.3);
        transform:translateX(-100%);
        transition:transform 0.3s ease;
        z-index:99;
        display:flex;
        flex-direction:column;
    }
    .question-sheet.open {
        transform:translateX(0);
    }
    .question-sheet__header {
        padding:18px 20px 12px;
        border-bottom:1px solid #e5e7eb;
        display:flex;
        justify-content:space-between;
        align-items:center;
    }
    .question-sheet__body {
        overflow:auto;
        padding:18px 20px;
        flex:1;
    }
    .question-sheet__card {
        border:1px solid #e5e7eb;
        padding:12px 14px;
        border-radius:12px;
        margin-bottom:10px;
        cursor:pointer;
        transition:border-color 0.2s ease;
    }
    .question-sheet__card.pending {
        background:#f8fafc;
    }
    .question-sheet__card.correct {
        background:#ecfccb;
    }
    .question-sheet__card.wrong {
        background:#fee2e2;
    }
    .subjective-input {
        flex:1;
        min-width:220px;
        border:1px solid #d1d5db;
        border-radius:10px;
        padding:10px 12px;
    }
    @media (max-width:768px) {
        .question-sheet {
            width:100%;
        }
    }
</style>

<div th:with="firstQuestion=${#lists.isEmpty(questions) ? null : questions[0]}">

    <h1 class="page-title">My Questions</h1>
    <div class="card" style="margin-bottom:14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <form th:action="@{/quiz/list}" method="get" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <select name="folderId"
                    style="min-width:200px; padding:8px 10px; border-radius:8px; border:1px solid #d1d5db;">
                <option value="" th:selected="${selectedFolder == null}">ì „ì²´ í´ë”</option>
                <option th:each="folder : ${folders}"
                        th:value="${folder.id}"
                        th:text="${folder.name}"
                        th:selected="${selectedFolder != null and selectedFolder.id == folder.id}">
                </option>
            </select>
            <button type="submit" class="btn btn-outline" style="padding:6px 12px;">í´ë” ì ìš©</button>
        </form>
        <a th:href="@{/folders}" class="btn btn-outline" style="margin-left:auto;">ğŸ“‚ í´ë” ê´€ë¦¬</a>
    </div>

    <div th:if="${message}" class="alert alert-success" style="margin-bottom:14px;">
        <span th:text="${message}"></span>
    </div>

    <div th:if="${firstQuestion == null}" class="card" style="text-align:center; padding:36px 20px;">
        ì•„ì§ ìƒì„±ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. PDFë¥¼ ì—…ë¡œë“œí•˜ê³  ë¬¸ì œë¥¼ ë§Œë“¤ì–´ ë³´ì„¸ìš”.
    </div>

        <div th:if="${firstQuestion != null}" class="highlight-card"
             th:data-correct-answer="${firstQuestion.answer}"
             th:data-has-choice="${firstQuestion.multipleChoice}">
        <div class="highlight-header">
            <span class="highlight-pill">ì˜¤ëŠ˜ì˜ ì²« ë¬¸ì œ</span>
            <div class="highlight-meta">
                <span th:text="'ë¬¸ì œ ' + ${firstQuestion.numberTag}">ë¬¸ì œ 1</span>
                <span th:text="${firstQuestion.createdAtFormatted}">2024.01.01</span>
            </div>
        </div>

        <h2 style="font-size:20px; margin:0 0 12px; white-space:pre-wrap;"
            th:text="${firstQuestion.questionText}">ë¬¸ì œ ë‚´ìš©</h2>

        <!-- ê°ê´€ì‹ ì„ íƒì§€ -->
        <div th:if="${firstQuestion.multipleChoice}"
             class="choice-grid"
             id="interactiveChoices">
            <div class="choice-chip"
                 data-role="choice-option"
                 th:each="choice : ${firstChoiceList}"
                 th:data-value="${choice.value}">
                <span th:text="${choice.number != null ? choice.number + '.' : ''}" style="font-weight:700; min-width:20px;"></span>
                <span th:text="${choice.text}"></span>
            </div>
        </div>

        <!-- ì£¼ê´€ì‹ ì…ë ¥ -->
        <div th:if="${!firstQuestion.multipleChoice}"
             class="check-panel">
            <input type="text"
                   id="subjectiveAnswer"
                   class="subjective-input"
                   placeholder="ì •ë‹µì„ ì§ì ‘ ì…ë ¥í•´ ë³´ì„¸ìš”">
        </div>

        <div class="check-panel" style="margin-top:10px;">
            <button type="button"
                    class="btn"
                    id="interactiveCheck"
                    style="flex:0 0 auto;">
                ì •ë‹µ í™•ì¸
            </button>

            <!-- ğŸ”§ ì—¬ê¸° ë¶€ë¶„ì´ ë¬¸ì œì˜€ë˜ ê³³: th:href í•˜ë‚˜ë¡œ í•©ì¹¨ -->
            <a th:href="${selectedFolder != null} ? @{/quiz/solve/{id}(id=${firstQuestion.id}, folderId=${selectedFolder.id})} : @{/quiz/solve/{id}(id=${firstQuestion.id})}"
               class="btn">
                ë°”ë¡œ í’€ëŸ¬ê°€ê¸°
            </a>
        </div>

        <p id="inlineResultMessage" style="margin-top:10px; font-size:14px;"></p>
    </div>

    <button type="button"
            class="question-sheet-toggle"
            id="questionSheetToggle">
        ë¬¸ì œ ëª©ë¡
    </button>

    <div class="question-sheet" id="questionSheet">
        <div class="question-sheet__header">
            <div>
                <strong>ë¬¸ì œ ëª©ë¡</strong>
                <p style="margin:4px 0 0; font-size:13px; color:#6b7280;">
                    ì´ <span th:text="${totalElements}">0</span>ê°œ
                </p>
            </div>
            <button type="button"
                    class="btn btn-outline"
                    style="padding:6px 12px;"
                    id="closeSheetBtn">
                ë‹«ê¸°
            </button>
        </div>

        <div class="question-sheet__body">

            <div th:if="${#lists.isEmpty(questions)}"
                 style="text-align:center; color:#9ca3af;">
                ì•„ì§ ë¬¸ì œê°€ ì—†ì–´ìš”.
            </div>

            <div th:each="q : ${questions}"
                 class="question-sheet__card"
                 th:classappend="${not q.solved ? ' pending' : (q.correct != null and q.correct ? ' correct' : ' wrong')}"
                 th:data-link="${selectedFolder != null} ? @{/quiz/solve/{id}(id=${q.id}, folderId=${selectedFolder.id})} : @{/quiz/solve/{id}(id=${q.id})}">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <strong th:text="'ë¬¸ì œ ' + ${q.numberTag}">ë¬¸ì œ</strong>
                    <span style="font-size:12px; color:#6b7280;"
                          th:text="${q.createdAtFormatted}">ë‚ ì§œ</span>
                </div>
                <p style="margin:8px 0 0; font-size:13px; color:#4b5563; white-space:pre-wrap;"
                   th:text="${q.questionText}"></p>
            </div>

            <div class="pagination" th:if="${totalPages > 1}">
                <a class="page-button"
                   th:classappend="${hasPrevious} ? '' : ' disabled'"
                   th:href="${hasPrevious} ? (${selectedFolder != null} ? @{/quiz/list(page=${currentPage - 1}, folderId=${selectedFolder.id})} : @{/quiz/list(page=${currentPage - 1})}) : '#'}">
                    â† ì´ì „
                </a>
                <span class="page-info"
                      th:text="'í˜ì´ì§€ ' + (${currentPage} + 1) + ' / ' + ${totalPages}">í˜ì´ì§€</span>
                <a class="page-button"
                   th:classappend="${hasNext} ? '' : ' disabled'"
                   th:href="${hasNext} ? (${selectedFolder != null} ? @{/quiz/list(page=${currentPage + 1}, folderId=${selectedFolder.id})} : @{/quiz/list(page=${currentPage + 1})}) : '#'}">
                    ë‹¤ìŒ â†’
                </a>
            </div>
        </div>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const sheet = document.getElementById('questionSheet');
        const toggle = document.getElementById('questionSheetToggle');
        const closeBtn = document.getElementById('closeSheetBtn');
        if (sheet && toggle) {
            const toggleSheet = () => sheet.classList.toggle('open');
            toggle.addEventListener('click', toggleSheet);
            if (closeBtn) closeBtn.addEventListener('click', toggleSheet);
        }

        document.querySelectorAll('.question-sheet__card').forEach(card => {
            card.addEventListener('click', () => {
                const link = card.dataset.link;
                if (link) window.location.href = link;
            });
        });

        const normalizeText = (text) => {
            if (!text) return '';
            return text.trim().replace(/[^0-9A-Za-zê°€-í£]/g, '').toLowerCase();
        };

        const highlightContainer = document.querySelector('.highlight-card');
        const checkBtn = document.getElementById('interactiveCheck');
        if (highlightContainer && checkBtn) {
            const isChoice = highlightContainer.dataset.hasChoice === 'true';
            const correctAnswer = normalizeText(highlightContainer.dataset.correctAnswer || '');
            const resultMsg = document.getElementById('inlineResultMessage');
            const choiceButtons = document.querySelectorAll('[data-role="choice-option"]');
            let selectedValue = '';

            choiceButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    choiceButtons.forEach(b => b.classList.remove('selected', 'wrong'));
                    btn.classList.add('selected');
                    selectedValue = btn.dataset.value || '';
                });
            });

            const evaluate = () => {
                choiceButtons.forEach(b => b.classList.remove('correct', 'wrong'));
                if (resultMsg) resultMsg.textContent = '';

                let userInput = selectedValue;
                if (!isChoice) {
                    const subjectiveInput = document.getElementById('subjectiveAnswer');
                    userInput = subjectiveInput ? subjectiveInput.value : '';
                }
                if (!userInput || normalizeText(userInput) === '') {
                    if (resultMsg) {
                        resultMsg.style.color = '#dc2626';
                        resultMsg.textContent = 'ë‹µì„ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
                    }
                    return;
                }

                const normalizedUser = normalizeText(userInput);
                const isCorrect = normalizedUser === correctAnswer;

                if (isChoice) {
                    const correctBtn = Array.from(choiceButtons).find(btn =>
                        normalizeText(btn.dataset.value || '') === correctAnswer
                    );
                    if (correctBtn) correctBtn.classList.add('correct');
                    const picked = Array.from(choiceButtons).find(btn => btn.classList.contains('selected'));
                    if (picked && !isCorrect) picked.classList.add('wrong');
                }

                if (resultMsg) {
                    resultMsg.style.color = isCorrect ? '#16a34a' : '#dc2626';
                    resultMsg.textContent = isCorrect ? 'ì •ë‹µì…ë‹ˆë‹¤! ğŸ‘' : 'ì•„ì‰¬ì›Œìš”! ì •ë‹µì„ í™•ì¸í•´ ë³´ì„¸ìš”.';
                }
            };

            checkBtn.addEventListener('click', evaluate);
        }
    });
</script>
</body>
</html>
