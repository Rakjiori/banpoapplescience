<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{layout :: layout(~{::body})}">
<body>
<style>
    .highlight-card {
        background: linear-gradient(135deg, #fef3c7, #fff7ed);
        border-radius: 18px;
        padding: 20px;
        box-shadow: 0 12px 30px rgba(0,0,0,0.08);
        margin-bottom: 18px;
    }
    .highlight-header {
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        margin-bottom:12px;
    }
    .highlight-pill {
        background:#1f2937;
        color:#fff;
        padding:4px 10px;
        border-radius:999px;
        font-size:12px;
        letter-spacing:0.06em;
        text-transform:uppercase;
    }
    .highlight-meta {
        color:#6b7280;
        font-size:12px;
        display:flex;
        gap:8px;
    }
    .choice-grid {
        display:flex;
        flex-direction:column;
        gap:10px;
        margin-top:12px;
    }
    .choice-chip {
        border:1px solid rgba(31,41,55,0.15);
        border-radius:12px;
        padding:10px 12px;
        background:#fff;
        display:flex;
        gap:8px;
        align-items:flex-start;
        cursor:pointer;
        transition:all 0.2s ease;
        font-size:14px;
    }
    .choice-chip:hover {
        border-color:#111827;
    }
    .choice-chip.selected {
        border-color:#6366f1;
        background:#eef2ff;
    }
    .choice-chip.correct {
        border-color:#16a34a;
        background:#dcfce7;
    }
    .choice-chip.wrong {
        border-color:#dc2626;
        background:#fee2e2;
    }
.check-panel {
    display:flex;
    gap:10px;
    margin-top:16px;
    flex-wrap:wrap;
}
.filter-tabs {
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin:0 0 12px;
}
.filter-btn {
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #e5e7eb;
    background:#f8fafc;
    color:#0f172a;
    font-weight:700;
    font-size:13px;
    cursor:pointer;
    transition:0.15s ease;
}
    .filter-btn.active {
        border-color:#6366f1;
        color:#ffffff;
        background:#6366f1;
        box-shadow:0 10px 20px rgba(99,102,241,0.3);
    }
    .pill-soft {
        display:inline-flex;
        align-items:center;
        padding:6px 10px;
        border-radius:999px;
        background:#f1f5f9;
        color:#0f172a;
        font-weight:700;
        gap:6px;
    }
    .discussion-modal {
        position:fixed;
        inset:0;
        background:rgba(0,0,0,0.45);
        display:none;
        align-items:center;
        justify-content:center;
        z-index:12000;
    }
    .discussion-card {
        background:#fff;
        border-radius:12px;
        padding:16px;
        width:min(520px, 92vw);
        max-height:80vh;
        box-shadow:0 16px 36px rgba(0,0,0,0.25);
        display:flex;
        flex-direction:column;
        gap:10px;
    }
    .discussion-list {
        border:1px solid #e5e7eb;
        border-radius:10px;
        padding:10px;
        max-height:320px;
        overflow:auto;
        display:flex;
        flex-direction:column;
        gap:8px;
        background:#f8fafc;
    }
    .share-modal {
        position:fixed;
        inset:0;
        background:rgba(0,0,0,0.45);
        display:none;
        align-items:center;
        justify-content:center;
        z-index:12000;
    }
    .share-card {
        background:#fff;
        border-radius:12px;
        padding:16px;
        width:min(520px, 92vw);
        max-height:80vh;
        box-shadow:0 16px 36px rgba(0,0,0,0.25);
        display:flex;
        flex-direction:column;
        gap:10px;
    }
    .friend-checkbox {
        display:flex;
        align-items:center;
        gap:8px;
        padding:6px 8px;
        border:1px solid #e5e7eb;
        border-radius:8px;
        margin-bottom:6px;
    }
.bookmark-btn {
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 12px;
        font-weight:600;
    }
    .bookmark-icon {
        transition:color 0.2s ease;
        color:#9ca3af;
    }
    .bookmark-btn.active {
        border-color:#f97316;
        color:#f97316;
        background:#fff7ed;
    }
    .bookmark-btn.active .bookmark-icon {
        color:#f97316;
    }
    .question-sheet-toggle {
        position:fixed;
        left:24px;
        bottom:72px;
        z-index:90;
        border:none;
        border-radius:999px;
        background:rgba(17,24,39,0.9);
        color:#fff;
        font-weight:600;
        padding:9px 14px;
        font-size:12px;
        box-shadow:0 8px 20px rgba(0,0,0,0.2);
        cursor:pointer;
        opacity:0.9;
        backdrop-filter:blur(4px);
        transition: opacity 0.15s ease, box-shadow 0.15s ease;
    }
    /* ë²„íŠ¼ ìœ„ì¹˜ ê³ ì •: í˜¸ë²„ ì‹œ ì‹œê° íš¨ê³¼ë§Œ ë³€ê²½ */
    .question-sheet-toggle:hover {
        opacity:1;
        box-shadow:0 12px 26px rgba(0,0,0,0.25);
    }
    .question-sheet {
        position:fixed;
        left:0;
        bottom:0;
        width:380px;
        max-height:80vh;
        background:#fff;
        border-top-right-radius:24px;
        border-top-left-radius:0;
        box-shadow:0 20px 45px rgba(0,0,0,0.3);
        transform:translateX(-100%);
        transition:transform 0.3s ease;
        z-index:99;
        display:flex;
        flex-direction:column;
    }
    .question-sheet.open {
        transform:translateX(0);
    }
    .question-sheet__header {
        padding:18px 20px 12px;
        border-bottom:1px solid #e5e7eb;
        display:flex;
        justify-content:space-between;
        align-items:center;
    }
    .question-sheet__body {
        overflow:auto;
        padding:18px 20px;
        flex:1;
    }
    .question-sheet__card {
        border:1px solid #e5e7eb;
        padding:12px 14px;
        border-radius:12px;
        margin-bottom:10px;
        cursor:pointer;
        transition:border-color 0.2s ease;
    }
    .question-sheet__card.pending {
        background:#f8fafc;
    }
    .question-sheet__card.correct {
        background:#ecfccb;
    }
    .question-sheet__card.wrong {
        background:#fee2e2;
    }
    .subjective-input {
        flex:1;
        min-width:220px;
        border:1px solid #d1d5db;
        border-radius:10px;
        padding:10px 12px;
    }
    @media (max-width:768px) {
        .question-sheet {
            width:100%;
        }
        .check-panel {
            flex-direction:column;
            align-items:stretch;
        }
        .choice-chip {
            width:100%;
        }
        .filter-tabs {
            gap:6px;
        }
        .filter-btn {
            flex:1 1 auto;
            text-align:center;
        }
        .card {
            padding:14px;
        }
    }
</style>

<div style="padding-bottom:120px;">

    <div class="surface-card stack" style="margin-bottom:14px;">
        <div class="filter-tabs">
            <button type="button" class="filter-btn active" data-filter="all">ì „ì²´</button>
            <button type="button" class="filter-btn" data-filter="correct">ë§ì€ ë¬¸ì œ</button>
            <button type="button" class="filter-btn" data-filter="wrong">í‹€ë¦° ë¬¸ì œ</button>
            <button type="button" class="filter-btn" data-filter="bookmark">ë¶ë§ˆí¬</button>
        </div>
        <div id="filterEmptyMessage" style="display:none; color:#6b7280; font-weight:600;">
            ì¡°ê±´ì— ë§ëŠ” ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
        <div id="filterLists" class="action-row" style="display:none; gap:10px; flex-wrap:wrap;">
            <div id="correctListContainer" class="badge-chip" style="flex:1 1 260px; display:none;">
                <div class="metric-label">ë§ì€ ë¬¸ì œ</div>
                <div id="correctList" style="display:flex; flex-wrap:wrap; gap:6px;"></div>
            </div>
            <div id="wrongListContainer" class="badge-chip" style="flex:1 1 260px; display:none;">
                <div class="metric-label">í‹€ë¦° ë¬¸ì œ</div>
                <div id="wrongList" style="display:flex; flex-wrap:wrap; gap:6px;"></div>
            </div>
            <div id="bookmarkListContainer" class="badge-chip" style="flex:1 1 260px; display:none;">
                <div class="metric-label">ë¶ë§ˆí¬</div>
                <div id="bookmarkList" style="display:flex; flex-wrap:wrap; gap:6px;"></div>
            </div>
        </div>
        <div class="action-row" style="justify-content:space-between; gap:12px;">
            <form th:action="@{/quiz/list}" method="get" class="action-row" style="gap:10px; flex-wrap:wrap;">
                <select id="quizFolderSelect"
                        name="folderId"
                        class="group-input"
                        style="min-width:200px;">
                    <option th:each="folder : ${folders}"
                            th:value="${folder.id}"
                            th:text="${folder.name}"
                            th:selected="${selectedFolder != null and selectedFolder.id == folder.id}">
                    </option>
                </select>
            </form>
            <a th:href="@{/folders}" class="ghost-link" style="margin-left:auto;">ğŸ“‚ í´ë” ê´€ë¦¬</a>
        </div>
    </div>

    <div th:if="${message}" class="alert alert-success" style="margin-bottom:14px;">
        <span th:text="${message}"></span>
    </div>
    <div th:if="${error}" class="alert alert-danger" style="margin-bottom:14px;">
        <span th:text="${error}"></span>
    </div>

    <div th:if="${firstQuestion == null}" class="card" style="text-align:center; padding:36px 20px;">
        ì•„ì§ ìƒì„±ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. PDFë¥¼ ì—…ë¡œë“œí•˜ê³  ë¬¸ì œë¥¼ ë§Œë“¤ì–´ ë³´ì„¸ìš”.
    </div>

        <div th:if="${firstQuestion != null}" class="highlight-card"
             th:data-correct-answer="${firstQuestion.answer}"
             th:data-has-choice="${firstChoiceList != null and !#lists.isEmpty(firstChoiceList)}">
        <div class="highlight-header">
            <span class="highlight-pill">ì˜¤ëŠ˜ì˜ ì²« ë¬¸ì œ</span>
            <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
                <div class="highlight-meta" style="gap:6px;">
                    <span id="questionNumberLabel" th:text="'ë¬¸ì œ ' + ${firstQuestion.numberTag}">ë¬¸ì œ 1</span>
                    <span id="questionDateLabel" th:text="${firstQuestion.createdAtFormatted}">2024.01.01</span>
                </div>
                <button type="button" class="btn btn-outline bookmark-btn" id="bookmarkButton">
                    <span class="bookmark-icon" aria-hidden="true">ğŸ”–</span>
                    <span class="bookmark-label">ë¶ë§ˆí¬ ì €ì¥</span>
                </button>
            </div>
        </div>

        <h2 style="font-size:17px; margin:0 0 10px; white-space:pre-wrap;"
            id="questionTextContent"
            th:text="${firstQuestion.questionText}">ë¬¸ì œ ë‚´ìš©</h2>

        <div class="choice-grid"
             id="interactiveChoices"
             th:style="${firstChoiceList != null and !#lists.isEmpty(firstChoiceList)} ? '' : 'display:none;'">
            <div class="choice-chip"
                 data-role="choice-option"
                 th:each="choice : ${firstChoiceList}"
                 th:data-value="${choice.value}">
                <span th:text="${choice.number != null ? choice.number + '.' : ''}" style="font-weight:700; min-width:20px;"></span>
                <span th:text="${choice.text}"></span>
            </div>
        </div>

        <div class="check-panel"
             id="subjectiveContainer"
             th:style="${firstChoiceList != null and !#lists.isEmpty(firstChoiceList)} ? 'display:none;' : ''">
            <input type="text"
                   id="subjectiveAnswer"
                   class="subjective-input"
                   placeholder="ì •ë‹µì„ ì§ì ‘ ì…ë ¥í•´ ë³´ì„¸ìš”">
        </div>

        <div class="check-panel" style="margin-top:10px;">
            <button type="button"
                    class="btn"
                    id="interactiveCheck"
                    style="flex:0 0 auto;">
                ì •ë‹µ í™•ì¸
            </button>
            <button type="button"
                    class="btn btn-outline"
                    id="prevQuestionButton"
                    style="flex:0 0 auto;">
                ì´ì „ ë¬¸ì œ
            </button>
            <button type="button"
                    class="btn btn-outline"
                    id="nextQuestionButton"
                    style="flex:0 0 auto;">
                ë‹¤ìŒ ë¬¸ì œ
            </button>
            <button type="button"
                    class="btn btn-outline"
                    id="openShareButton"
                    style="flex:0 0 auto;">
                ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ê¸°
            </button>
        </div>

        <p id="inlineResultMessage" style="margin-top:10px; font-size:14px;"></p>
        <div id="inlineExplanation" style="display:none; margin-top:6px; padding:10px; border-radius:8px; background:#f9fafb; color:#374151; font-size:14px; white-space:pre-wrap;"></div>

    </div>

    <div th:if="${memberships != null and !#lists.isEmpty(memberships) and firstQuestion != null}" class="card" style="margin-top:14px;">
        <h3 style="margin:0 0 10px;">ê·¸ë£¹ì— ë¬¸ì œ ê³µìœ </h3>
        <form id="shareGroupForm"
              th:action="@{/groups/{groupId}/share/{questionId}(groupId=${memberships.get(0).group.id},questionId=${firstQuestion != null ? firstQuestion.id : 0})}"
              method="post"
              style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <select id="shareGroupSelect"
                    name="groupId"
                    style="min-width:200px; padding:8px 10px; border-radius:8px; border:1px solid #d1d5db;"
                    onchange="this.form.action='/groups/' + this.value + '/share/' + this.form.querySelector('[name=questionId]').value;">
                <option th:each="mem : ${memberships}"
                        th:value="${mem.group.id}"
                        th:text="${mem.group.name}">
                </option>
            </select>
            <input type="hidden" name="questionId" id="shareQuestionId" th:value="${firstQuestion != null ? firstQuestion.id : 0}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <button type="submit" class="btn btn-outline">ë¬¸ì œë¥¼ ê·¸ë£¹ì— ê³µìœ </button>
        </form>
        <p style="margin-top:8px; color:#6b7280; font-size:13px;">ìƒì„¸ ê³µìœ ëŠ” ê° ë¬¸ì œ í’€ì´ í™”ë©´ì—ì„œë„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>

    <button type="button"
            class="question-sheet-toggle"
            id="questionSheetToggle">
        list
    </button>

    <div class="question-sheet" id="questionSheet">
        <div class="question-sheet__header">
            <div>
                <strong>ë¬¸ì œ ëª©ë¡</strong>
                <p style="margin:4px 0 0; font-size:13px; color:#6b7280;">
                    ì´ <span th:text="${totalElements}">0</span>ê°œ
                </p>
            </div>
            <button type="button"
                    class="btn btn-outline"
                    style="padding:6px 12px;"
                    id="closeSheetBtn">
                ë‹«ê¸°
            </button>
        </div>

        <div class="question-sheet__body">

            <div th:if="${#lists.isEmpty(questions)}"
                 style="text-align:center; color:#9ca3af;">
                ì•„ì§ ë¬¸ì œê°€ ì—†ì–´ìš”.
            </div>

            <div th:each="q : ${questions}"
                 class="question-sheet__card"
                 th:classappend="${not q.solved ? ' pending' : (q.correct != null and q.correct ? ' correct' : ' wrong')}"
                 th:data-link="${selectedFolder != null} ? @{/quiz/solve/{id}(id=${q.id}, folderId=${selectedFolder.id})} : @{/quiz/solve/{id}(id=${q.id})}"
                 th:data-id="${q.id}"
                 th:data-number="${q.numberTag}"
                 th:data-date="${q.createdAtFormatted}"
                 th:data-text="${q.questionText}"
                 th:data-answer="${q.answer}"
                 th:data-multiple-choice="${q.multipleChoice or (q.choices != null and !#strings.isEmpty(q.choices))}"
                 th:data-choices="${q.choices}"
                 th:data-explanation="${q.explanation}"
                 th:data-correct-state="${q.correct == null ? 'pending' : (q.correct ? 'correct' : 'wrong')}"
                 th:data-folder-id="${q.folder != null ? q.folder.id : ''}">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <strong th:text="'ë¬¸ì œ ' + ${q.numberTag}">ë¬¸ì œ</strong>
                    <span style="font-size:12px; color:#6b7280;"
                          th:text="${q.createdAtFormatted}">ë‚ ì§œ</span>
                </div>
                <p style="margin:8px 0 0; font-size:13px; color:#4b5563; white-space:pre-wrap;"
                   th:text="${q.questionText}"></p>
            </div>

            <div class="pagination" th:if="${totalPages > 1}">
                <a class="page-button"
                   th:if="${hasPrevious and selectedFolder != null}"
                   th:href="@{/quiz/list(page=${currentPage - 1}, folderId=${selectedFolder.id})}">â† ì´ì „</a>
                <a class="page-button"
                   th:if="${hasPrevious and selectedFolder == null}"
                   th:href="@{/quiz/list(page=${currentPage - 1})}">â† ì´ì „</a>
                <a class="page-button disabled"
                   th:unless="${hasPrevious}"
                   href="#">â† ì´ì „</a>
                <span class="page-info"
                      th:text="'í˜ì´ì§€ ' + (${currentPage} + 1) + ' / ' + ${totalPages}">í˜ì´ì§€</span>
                <a class="page-button"
                   th:if="${hasNext and selectedFolder != null}"
                   th:href="@{/quiz/list(page=${currentPage + 1}, folderId=${selectedFolder.id})}">ë‹¤ìŒ â†’</a>
                <a class="page-button"
                   th:if="${hasNext and selectedFolder == null}"
                   th:href="@{/quiz/list(page=${currentPage + 1})}">ë‹¤ìŒ â†’</a>
                <a class="page-button disabled"
                   th:unless="${hasNext}"
                   href="#">ë‹¤ìŒ â†’</a>
            </div>
        </div>
    </div>

    <!-- í•¨ê»˜ í’€ê¸° ëª¨ë‹¬ -->
    <div class="share-modal" id="shareModal">
        <div class="share-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="font-weight:700;">ì¹œêµ¬ì™€ í•¨ê»˜ í’€ê¸°</div>
                <button type="button" class="btn btn-outline" id="closeShareButton" style="padding:6px 12px;">ë‹«ê¸°</button>
            </div>
            <p style="margin:6px 0 10px; color:#6b7280; font-size:13px;">ì¹œêµ¬ë¥¼ ì„ íƒí•˜ë©´ í•¨ê»˜ í’€ê¸° ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.</p>
            <div id="shareFriendList">
                <div th:if="${#lists.isEmpty(friends)}" style="color:#6b7280;">ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¹œêµ¬ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</div>
                <label class="friend-checkbox" th:each="fr : ${friends}">
                    <input type="checkbox" name="shareFriendIds" th:value="${fr.id}">
                    <div>
                        <div style="font-weight:700;" th:text="${fr.to.username}">friend</div>
                        <div style="font-size:12px; color:#6b7280;">í¬ì¸íŠ¸: <span th:text="${fr.to.points}">0</span> Â· ì—°ì† í’€ì´: <span th:text="${fr.to.streak}">0</span>ì¼</div>
                    </div>
                </label>
            </div>
            <button type="button" class="btn" id="sendShareButton">ìš”ì²­ ë³´ë‚´ê¸°</button>
        </div>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const sheet = document.getElementById('questionSheet');
        const toggle = document.getElementById('questionSheetToggle');
        const closeBtn = document.getElementById('closeSheetBtn');
        if (sheet && toggle) {
            const toggleSheet = () => sheet.classList.toggle('open');
            toggle.addEventListener('click', toggleSheet);
            if (closeBtn) closeBtn.addEventListener('click', toggleSheet);
        }

        const cards = Array.from(document.querySelectorAll('.question-sheet__card'));

        const parseChoices = (raw) => {
            if (!raw) return [];
            const cleaned = raw.toString();
            const regex = /(\d+)[).]\s*([\s\S]*?)(?=\s*\d+[).]|\s*$)/g;
            const result = [];
            let match;
            while ((match = regex.exec(cleaned)) !== null) {
                const number = match[1]?.trim() || null;
                const text = (match[2] || '').trim();
                if (text) {
                    result.push({ number, text, value: number || text });
                }
            }
            if (result.length) return result;
            return cleaned
                .split(/\r?\n|[,;]+/)
                .map(item => item.trim())
                .filter(Boolean)
                .map(text => ({ number: null, text, value: text }));
        };

        const normalizeText = (text) => {
            if (!text) return '';
            return text.trim().replace(/[^0-9A-Za-zê°€-í£]/g, '').toLowerCase();
        };

        const loadBookmarks = () => {
            try {
                return new Set(JSON.parse(localStorage.getItem('quizBookmarks') || '[]'));
            } catch(e){
                return new Set();
            }
        };
        const saveBookmarks = (set) => {
            localStorage.setItem('quizBookmarks', JSON.stringify(Array.from(set)));
        };
        const bookmarkSet = loadBookmarks();
        const loadSolvedDates = () => {
            try { return new Set(JSON.parse(localStorage.getItem('solveDates') || '[]')); }
            catch(e){ return new Set(); }
        };
        const solvedDates = loadSolvedDates();
        const saveSolvedDates = () => {
            localStorage.setItem('solveDates', JSON.stringify(Array.from(solvedDates)));
        };
        const solvedState = (() => {
            try { return JSON.parse(localStorage.getItem('quizSolvedState') || '{}'); }
            catch(e){ return {}; }
        })();
        const savedAnswers = (() => {
            try { return JSON.parse(localStorage.getItem('quizSavedAnswers') || '{}'); }
            catch(e){ return {}; }
        })();

        const allQuestions = [];
        const cardIdToIndex = new Map();
        cards.forEach((card, idx) => {
            const id = card.dataset.id || '';
            const bookmarked = bookmarkSet.has(id);
            card.dataset.bookmarked = bookmarked ? 'true' : 'false';
            const hasChoices = (card.dataset.choices || '').trim().length > 0;
            allQuestions.push({
                id,
                number: card.dataset.number || '',
                date: card.dataset.date || '',
                text: card.dataset.text || '',
                answer: card.dataset.answer || '',
                explanation: card.dataset.explanation || '',
                multipleChoice: card.dataset.multipleChoice === 'true' || hasChoices,
                choices: parseChoices(card.dataset.choices || ''),
                correctState: solvedState[id] || card.dataset.correctState || 'pending',
                bookmarked,
                folderId: card.dataset.folderId || ''
            });
            cardIdToIndex.set(id, idx);
        });
        let filteredQuestions = [...allQuestions];

        const highlightContainer = document.querySelector('.highlight-card');
        const choiceContainer = document.getElementById('interactiveChoices');
        const subjectiveContainer = document.getElementById('subjectiveContainer');
        const subjectiveInput = document.getElementById('subjectiveAnswer');
        const numberLabel = document.getElementById('questionNumberLabel');
        const dateLabel = document.getElementById('questionDateLabel');
        const textEl = document.getElementById('questionTextContent');
        const resultMsg = document.getElementById('inlineResultMessage');
        const explanationEl = document.getElementById('inlineExplanation');
        const checkBtn = document.getElementById('interactiveCheck');
        const prevBtn = document.getElementById('prevQuestionButton');
        const nextBtn = document.getElementById('nextQuestionButton');
        const bookmarkButton = document.getElementById('bookmarkButton');
        const bookmarkLabel = bookmarkButton ? bookmarkButton.querySelector('.bookmark-label') : null;
        const bookmarkIcon = bookmarkButton ? bookmarkButton.querySelector('.bookmark-icon') : null;
        const shareGroupForm = document.getElementById('shareGroupForm');
        const shareGroupSelect = document.getElementById('shareGroupSelect');
        const shareQuestionIdInput = document.getElementById('shareQuestionId');
        const filterButtons = Array.from(document.querySelectorAll('.filter-btn'));
        const filterEmpty = document.getElementById('filterEmptyMessage');
        const filterLists = document.getElementById('filterLists');
        const bookmarkListContainer = document.getElementById('bookmarkListContainer');
        const bookmarkList = document.getElementById('bookmarkList');
        const correctListContainer = document.getElementById('correctListContainer');
        const correctList = document.getElementById('correctList');
        const wrongListContainer = document.getElementById('wrongListContainer');
        const wrongList = document.getElementById('wrongList');
        const csrfToken = document.querySelector('meta[name=\"_csrf\"]')?.content || '';
        const csrfHeader = document.querySelector('meta[name=\"_csrf_header\"]')?.content || 'X-CSRF-TOKEN';
        const shareModal = document.getElementById('shareModal');
        const openShareButton = document.getElementById('openShareButton');
        const closeShareButton = document.getElementById('closeShareButton');
        const sendShareButton = document.getElementById('sendShareButton');
        const shareFriendList = document.getElementById('shareFriendList');
        const formatDateTime = (value) => {
            if (!value) return '';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '';
            return date.toLocaleString();
        };

        let currentIndex = 0;
        let selectedValue = '';
        let activeFilter = 'all';

        const bindChoiceEvents = () => {
            const choiceButtons = choiceContainer ? choiceContainer.querySelectorAll('[data-role="choice-option"]') : [];
            choiceButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    choiceButtons.forEach(b => b.classList.remove('selected', 'wrong'));
                    btn.classList.add('selected');
                    selectedValue = btn.dataset.value || '';
                });
            });
        };
        if (choiceContainer) {
            choiceContainer.addEventListener('click', (e) => {
                const target = e.target.closest('[data-role="choice-option"]');
                if (!target) return;
                choiceContainer.querySelectorAll('[data-role="choice-option"]').forEach(b => b.classList.remove('selected', 'wrong'));
                target.classList.add('selected');
                selectedValue = target.dataset.value || '';
            });
        }

        const renderQuestion = (idx) => {
            if (!highlightContainer || !filteredQuestions[idx]) return;
            const q = filteredQuestions[idx];
            currentIndex = idx;
            selectedValue = '';
            [checkBtn, nextBtn, openShareButton, bookmarkButton].forEach(btn => {
                if (btn) btn.disabled = false;
            });

            if (numberLabel) numberLabel.textContent = q.number ? `ë¬¸ì œ ${q.number}` : `ë¬¸ì œ ${idx + 1}`;
            if (dateLabel) dateLabel.textContent = q.date || '';
            if (textEl) textEl.textContent = q.text || '';
            const state = q.correctState || 'pending';
            if (resultMsg) {
                if (state === 'correct') {
                    resultMsg.style.color = '#16a34a';
                    resultMsg.textContent = 'ì´ë¯¸ ë§ì¶˜ ë¬¸ì œì…ë‹ˆë‹¤!';
                } else if (state === 'wrong') {
                    resultMsg.style.color = '#dc2626';
                    resultMsg.textContent = 'ì´ë¯¸ í’€ì´ë¨ (ì˜¤ë‹µ)';
                } else {
                    resultMsg.textContent = '';
                    resultMsg.style.color = '#111827';
                }
            }
            if (explanationEl) {
                if (state !== 'pending' && q.explanation) {
                    explanationEl.style.display = 'block';
                    explanationEl.textContent = `í•´ì„¤: ${q.explanation}`;
                } else {
                    explanationEl.style.display = 'none';
                    explanationEl.textContent = '';
                }
            }
            if (subjectiveInput) subjectiveInput.value = '';
           if (bookmarkButton && bookmarkLabel) {
                const isBookmarked = q.bookmarked;
                bookmarkButton.classList.toggle('active', isBookmarked);
                bookmarkButton.disabled = false;
                bookmarkLabel.textContent = isBookmarked ? 'ì €ì¥ë¨' : 'ì €ì¥í•˜ê¸°';
            }

            highlightContainer.dataset.correctAnswer = q.answer || '';
            highlightContainer.dataset.hasChoice = String(q.multipleChoice);

            if (q.multipleChoice) {
                if (choiceContainer) {
                    choiceContainer.innerHTML = '';
                    q.choices.forEach(choice => {
                        const div = document.createElement('div');
                        div.className = 'choice-chip';
                        div.dataset.role = 'choice-option';
                        div.dataset.value = choice.value || '';
                        div.dataset.number = choice.number || '';
                        div.innerHTML = `
                            <span style="font-weight:700; min-width:20px;">${choice.number ? choice.number + '.' : ''}</span>
                            <span>${choice.text || ''}</span>
                        `;
                        choiceContainer.appendChild(div);
                    });
                    choiceContainer.style.display = 'flex';
                }
                if (subjectiveContainer) subjectiveContainer.style.display = 'none';
            } else {
                if (choiceContainer) {
                    choiceContainer.innerHTML = '';
                    choiceContainer.style.display = 'none';
                }
                if (subjectiveContainer) subjectiveContainer.style.display = 'flex';
            }
            bindChoiceEvents();
            // ì €ì¥ëœ ë‹µë³€ ë³µì›
            const saved = savedAnswers[q.id];
            if (saved) {
                if (q.multipleChoice && choiceContainer) {
                    choiceContainer.querySelectorAll('[data-role="choice-option"]').forEach(opt => {
                        const val = opt.dataset.value || '';
                        const num = opt.dataset.number || '';
                        if (normalizeText(val) === normalizeText(saved) || num === saved) {
                            opt.classList.add('selected');
                        }
                    });
                } else if (subjectiveInput) {
                    subjectiveInput.value = saved;
                }
            }

            // ê·¸ë£¹ ê³µìœ  í¼ì˜ ë¬¸ì œ ID/ì•¡ì…˜ ì—…ë°ì´íŠ¸
            if (shareQuestionIdInput) {
                shareQuestionIdInput.value = q.id || '';
            }
            if (shareGroupForm && shareGroupSelect) {
                const gid = shareGroupSelect.value || '';
                if (gid && q.id) {
                    shareGroupForm.action = `/groups/${gid}/share/${q.id}`;
                }
            }
        };

        const evaluate = () => {
            const q = filteredQuestions[currentIndex];
            if (!q) return;

            const choiceButtons = choiceContainer ? choiceContainer.querySelectorAll('[data-role="choice-option"]') : [];
            choiceButtons.forEach(b => b.classList.remove('correct', 'wrong'));
            if (resultMsg) resultMsg.textContent = '';

            let userInput = selectedValue;
            if (!q.multipleChoice) {
                userInput = subjectiveInput ? subjectiveInput.value : '';
            }
            if ((q.correctState || 'pending') !== 'pending') {
                return; // ì´ë¯¸ í’€ì´ëœ ë¬¸ì œëŠ” ì¬ì±„ì í•˜ì§€ ì•ŠìŒ
            }

            if (!userInput || normalizeText(userInput) === '') {
                if (resultMsg) {
                    resultMsg.style.color = '#dc2626';
                    resultMsg.textContent = 'ë‹µì„ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
                }
                return;
            }

            const normalizedUser = normalizeText(userInput);
            const normalizedCorrect = normalizeText(q.answer || '');
            const userNumber = (userInput.match(/\d+/) || [''])[0];
            const correctNumber = ((q.answer || '').match(/\d+/) || [''])[0];
            const isCorrect = (normalizedCorrect !== '' && normalizedUser === normalizedCorrect)
                || (correctNumber !== '' && userNumber === correctNumber);

            if (q.multipleChoice) {
                const correctBtn = Array.from(choiceButtons).find(btn =>
                    normalizeText(btn.dataset.value || '') === normalizedCorrect
                    || (correctNumber && (btn.dataset.number === correctNumber || normalizeText(btn.dataset.number || '') === correctNumber))
                );
                if (correctBtn) correctBtn.classList.add('correct');
                const picked = Array.from(choiceButtons).find(btn => btn.classList.contains('selected'));
                if (picked && !isCorrect) picked.classList.add('wrong');
            }

            if (resultMsg) {
                resultMsg.style.color = isCorrect ? '#16a34a' : '#dc2626';
                resultMsg.textContent = isCorrect ? 'ì •ë‹µì…ë‹ˆë‹¤! ğŸ‘' : 'ì•„ì‰¬ì›Œìš”! ì •ë‹µì„ í™•ì¸í•´ ë³´ì„¸ìš”.';
            }
            if (!isCorrect && explanationEl) {
                const explanation = (q.explanation || '').trim();
                explanationEl.style.display = 'block';
                explanationEl.textContent = explanation ? `í•´ì„¤: ${explanation}` : 'í•´ì„¤ì´ ì•„ì§ ë“±ë¡ë˜ì§€ ì•Šì•˜ì–´ìš”.';
            } else if (explanationEl) {
                explanationEl.style.display = 'none';
                explanationEl.textContent = '';
            }

            if (csrfToken && q.id) {
                const params = new URLSearchParams();
                params.append('answer', userInput);
                if (q.folderId) params.append('folderId', q.folderId);
                fetch(`/quiz/inline-submit/${q.id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        [csrfHeader]: csrfToken
                    },
                    body: params.toString()
                }).then(() => {
                    // ì¹´ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸
                    const card = cards.find(c => c.dataset.id === q.id);
                    if (card) {
                        card.dataset.correctState = isCorrect ? 'correct' : 'wrong';
                        card.classList.remove('pending', 'correct', 'wrong');
                        card.classList.add(isCorrect ? 'correct' : 'wrong');
                    }
                    solvedState[q.id] = isCorrect ? 'correct' : 'wrong';
                    localStorage.setItem('quizSolvedState', JSON.stringify(solvedState));
                    savedAnswers[q.id] = userInput;
                    localStorage.setItem('quizSavedAnswers', JSON.stringify(savedAnswers));
                    const todayKey = new Date().toISOString().slice(0,10);
                    solvedDates.add(todayKey);
                    saveSolvedDates();
                    q.correctState = isCorrect ? 'correct' : 'wrong';
                    q.savedAnswer = userInput;
                    applyFilter(activeFilter, q.id, true);
                }).catch(()=>{});
            }
        };

        if (checkBtn) checkBtn.addEventListener('click', evaluate);
        const moveToNextUnsolved = () => {
            if (!filteredQuestions.length) return;
            const start = (currentIndex + 1) % filteredQuestions.length;
            let idx = start;
            do {
                if ((filteredQuestions[idx].correctState || 'pending') === 'pending') {
                    renderQuestion(idx);
                    return;
                }
                idx = (idx + 1) % filteredQuestions.length;
            } while (idx !== start);
            renderQuestion(start);
        };

        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                moveToNextUnsolved();
            });
        }
        if (prevBtn) {
            prevBtn.addEventListener('click', () => {
                if (!filteredQuestions.length) return;
                const prevIndex = (currentIndex - 1 + filteredQuestions.length) % filteredQuestions.length;
                renderQuestion(prevIndex);
            });
        }

        document.querySelectorAll('.question-sheet__card').forEach(card => {
            card.addEventListener('click', () => {
                const id = card.dataset.id;
                if (!id) return;
                const idx = cardIdToIndex.get(id);
                if (idx !== undefined) {
                    renderQuestion(idx);
                }
            });
        });
        if (bookmarkButton && bookmarkLabel) {
            bookmarkButton.addEventListener('click', () => {
                const q = filteredQuestions[currentIndex];
                if (!q) return;
                const isActive = bookmarkButton.classList.toggle('active');
                if (bookmarkLabel) {
                    bookmarkLabel.textContent = isActive ? 'ì €ì¥ë¨' : 'ì €ì¥í•˜ê¸°';
                }
                if (bookmarkIcon) {
                    bookmarkIcon.textContent = 'ğŸ”–';
                }
                q.bookmarked = isActive;
                if (isActive) {
                    bookmarkSet.add(q.id);
                } else {
                    bookmarkSet.delete(q.id);
                }
                const card = cards.find(c => c.dataset.id === q.id);
                if (card) card.dataset.bookmarked = isActive ? 'true' : 'false';
                saveBookmarks(bookmarkSet);
                applyFilter(activeFilter, q.id, true);
            });
        }

        // í•¨ê»˜ í’€ê¸° ëª¨ë‹¬
        const toggleShareModal = (show) => {
            if (!shareModal) return;
            shareModal.style.display = show ? 'flex' : 'none';
        };
        openShareButton?.addEventListener('click', (e) => {
            e.preventDefault();
            toggleShareModal(true);
        });
        closeShareButton?.addEventListener('click', (e) => {
            e.preventDefault();
            toggleShareModal(false);
        });
        sendShareButton?.addEventListener('click', async () => {
            if (!shareFriendList) return;
            const checked = Array.from(shareFriendList.querySelectorAll('input[name="shareFriendIds"]:checked'));
            if (!checked.length) {
                alert('ì¹œêµ¬ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                return;
            }
            const q = filteredQuestions[currentIndex];
            if (!q || !q.id) {
                alert('ë¬¸ì œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                return;
            }
            const params = new URLSearchParams();
            checked.forEach(c => params.append('friendIds', c.value));
            params.append('questionId', q.id);
            await fetch('/api/friends/share/bulk', {
                method:'POST',
                headers:{
                    'Content-Type':'application/x-www-form-urlencoded',
                    [csrfHeader]: csrfToken
                },
                body: params.toString()
            });
            alert('í•¨ê»˜ í’€ê¸° ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.');
            toggleShareModal(false);
        });
        // ê³µìœ  ëŒ€ìƒ ì—†ìœ¼ë©´ ë²„íŠ¼ ë¹„í™œì„±í™”
        if (shareFriendList && sendShareButton) {
            const hasOption = shareFriendList.querySelector('input[name="shareFriendIds"]');
            if (!hasOption) {
                sendShareButton.disabled = true;
                sendShareButton.textContent = 'ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤';
            }
        }

        const renderList = (container, listEl, items, color) => {
            if (!container || !listEl) return;
            container.style.display = 'none';
            listEl.innerHTML = '';
            if (!items.length) return;
            items.forEach((q, idx) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline';
                btn.style.padding = '6px 10px';
                btn.style.borderColor = '#e5e7eb';
                btn.style.background = color || '#fff';
                btn.textContent = q.number ? `ë¬¸ì œ ${q.number}` : `#${idx + 1}`;
                btn.addEventListener('click', () => {
                    const idxInFiltered = filteredQuestions.findIndex(item => item.id === q.id);
                    if (idxInFiltered >= 0) {
                        renderQuestion(idxInFiltered);
                    }
                });
                listEl.appendChild(btn);
            });
            container.style.display = 'block';
        };

        const applyFilter = (filter, targetId = null, preserveCurrent = false) => {
            activeFilter = filter;
            filterButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            const matcher = (q) => {
                if (filter === 'correct') return q.correctState === 'correct';
                if (filter === 'wrong') return q.correctState === 'wrong';
                if (filter === 'bookmark') return q.bookmarked;
                return true;
            };
            filteredQuestions = allQuestions.filter(matcher);
            cards.forEach(card => {
                const cardFilterState = card.dataset.correctState;
                const cardBookmarked = card.dataset.bookmarked === 'true';
                const isBookmarked = bookmarkSet.has(card.dataset.id || '');
                const match =
                    (filter === 'correct' && cardFilterState === 'correct') ||
                    (filter === 'wrong' && cardFilterState === 'wrong') ||
                    (filter === 'bookmark' && (isBookmarked || cardBookmarked)) ||
                    (filter === 'all');
                card.style.display = match ? 'block' : 'none';
            });
            if (filterEmpty) {
                filterEmpty.style.display = filteredQuestions.length ? 'none' : 'block';
            }
            if (filterLists) {
                filterLists.style.display = filteredQuestions.length ? 'flex' : 'none';
            }
            renderList(correctListContainer, correctList, [], null);
            renderList(wrongListContainer, wrongList, [], null);
            renderList(bookmarkListContainer, bookmarkList, [], null);
            const bookmarkItems = filteredQuestions.filter(q => q.bookmarked);
            const correctItems = filteredQuestions.filter(q => q.correctState === 'correct');
            const wrongItems = filteredQuestions.filter(q => q.correctState === 'wrong');
            if (filter === 'bookmark') {
                renderList(bookmarkListContainer, bookmarkList, bookmarkItems, '#f8fafc');
            } else if (filter === 'correct') {
                renderList(correctListContainer, correctList, correctItems, '#ecfccb');
            } else if (filter === 'wrong') {
                renderList(wrongListContainer, wrongList, wrongItems, '#fee2e2');
            }
            if (filteredQuestions.length > 0) {
                const nextIndex = targetId
                    ? Math.max(0, filteredQuestions.findIndex(q => q.id === targetId))
                    : 0;
                if (preserveCurrent && nextIndex >= 0) {
                    currentIndex = nextIndex;
                } else {
                    renderQuestion(nextIndex === -1 ? 0 : nextIndex);
                }
            } else if (textEl) {
                textEl.textContent = '';
                if (resultMsg) resultMsg.textContent = '';
                [checkBtn, nextBtn, openShareButton, bookmarkButton].forEach(btn => {
                    if (btn) btn.disabled = true;
                });
            }
        };

        filterButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                applyFilter(btn.dataset.filter || 'all');
            });
        });

        applyFilter('all');

        // ì¹´ë“œ í´ë¦­ ì‹œ í˜„ì¬ í˜ì´ì§€ì—ì„œ ë¬¸ì œ ì „í™˜
        cards.forEach(card => {
            card.addEventListener('click', () => {
                const id = card.dataset.id || '';
                let idx = filteredQuestions.findIndex(q => q.id === id);
                if (idx === -1) {
                    applyFilter(activeFilter, id);
                    idx = filteredQuestions.findIndex(q => q.id === id);
                }
                if (idx >= 0) {
                    renderQuestion(idx);
                }
            });
        });
        // ì´ˆê¸° í‘œì‹œ: ë¯¸í’€ì´ ìš°ì„ 
        const firstPendingIdx = filteredQuestions.findIndex(q => (q.correctState || 'pending') === 'pending');
        if (firstPendingIdx >= 0) {
            renderQuestion(firstPendingIdx);
        } else if (filteredQuestions.length) {
            renderQuestion(0);
        }

        const folderSelect = document.getElementById('quizFolderSelect');
        if (folderSelect) {
            if (!folderSelect.value) {
                const first = Array.from(folderSelect.options).find(o => o.value);
                if (first) folderSelect.value = first.value;
            }
            folderSelect.addEventListener('change', () => {
                const val = folderSelect.value;
                if (val === '') {
                    window.location.href = '/quiz/list';
                } else {
                    folderSelect.form?.submit();
                }
            });
        }
    });
</script>
</body>
</html>
