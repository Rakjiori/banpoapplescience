<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="layout :: layout(~{::body})">
<body>
<div>
    <h1 class="page-title">내 페이지</h1>
    <div class="card" style="display:flex; gap:14px; align-items:center; flex-wrap:wrap;">
        <div class="pill-soft">포인트: <span th:text="${user.points}">0</span></div>
        <div class="pill-soft">연속 풀이: <span th:text="${user.streak}">0</span>일</div>
        <div class="pill-soft">아이디: <span th:text="${user.username}">user</span></div>
    </div>

    <div class="card" style="margin-top:12px;">
        <h3 style="margin:0 0 8px;">친구 추가</h3>
        <form th:action="@{/friends/request}" method="post" style="display:flex; gap:8px; align-items:center;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <input type="text" name="username" placeholder="친구 아이디" style="padding:8px 10px; border:1px solid #d1d5db; border-radius:8px; flex:1;">
            <button type="submit" class="btn btn-outline" style="padding:6px 12px;">친구 추가</button>
        </form>
    </div>

    <div class="card">
        <h3 style="margin:0 0 8px;">친구 목록</h3>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
            <input type="text" id="friendSearch" placeholder="친구 검색" style="flex:1; padding:8px 10px; border:1px solid #d1d5db; border-radius:8px;">
            <select id="friendSort" style="padding:8px 10px; border:1px solid #d1d5db; border-radius:8px;">
                <option value="name">이름순</option>
                <option value="points">포인트순</option>
                <option value="streak">연속 풀이순</option>
            </select>
        </div>
        <div th:if="${#lists.isEmpty(friends)}" style="color:#6b7280;">아직 친구가 없습니다.</div>
        <div id="friendListContainer">
            <div th:each="f : ${friends}" class="friend-row" style="padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; gap:8px;"
                 th:data-name="${f.to.username}"
                 th:data-points="${f.to.points}"
                 th:data-streak="${f.to.streak}">
                <div>
                    <strong th:text="${f.to.username}">friend</strong>
                    <span style="color:#9ca3af; font-size:12px;" th:text="${#temporals.format(f.createdAt,'yyyy.MM.dd HH:mm')}">날짜</span>
                    <div style="color:#6b7280; font-size:12px; margin-top:4px;">
                        포인트: <span th:text="${f.to.points}">0</span> · 연속 풀이: <span th:text="${f.to.streak}">0</span>일
                    </div>
                </div>
                <div style="display:flex; gap:6px; align-items:center;" data-role="friend-share" th:data-friend-id="${f.id}">
                    <input type="text" placeholder="문제 ID" style="width:90px; padding:6px 8px; border:1px solid #d1d5db; border-radius:8px;">
                    <button class="btn btn-outline" style="padding:6px 10px;">공유</button>
                    <form th:action="@{/friends/remove}" method="post" style="margin:0;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <input type="hidden" name="friendId" th:value="${f.id}">
                        <button type="submit" class="btn btn-outline" style="padding:4px 10px;">삭제</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const search = document.getElementById('friendSearch');
        const sort = document.getElementById('friendSort');
        const rows = Array.from(document.querySelectorAll('.friend-row'));
        const render = () => {
            const term = (search?.value || '').toLowerCase();
            const sorted = rows.slice().filter(r => r.dataset.name?.toLowerCase().includes(term));
            sorted.sort((a,b) => {
                if (sort?.value === 'points') return (parseInt(b.dataset.points||0) - parseInt(a.dataset.points||0));
                if (sort?.value === 'streak') return (parseInt(b.dataset.streak||0) - parseInt(a.dataset.streak||0));
                return (a.dataset.name||'').localeCompare(b.dataset.name||'');
            });
            const container = document.getElementById('friendListContainer');
            if (!container) return;
            container.innerHTML = '';
            sorted.forEach(r => container.appendChild(r));
        };
        search?.addEventListener('input', render);
        sort?.addEventListener('change', render);
        render();
    });
</script>
</body>
</html>
