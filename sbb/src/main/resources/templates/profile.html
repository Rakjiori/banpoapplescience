<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="layout :: layout(~{::body})">
<body>
<div>
    <h1 class="page-title">ë‚´ í˜ì´ì§€</h1>
    <div id="profileBanner" class="card" style="display:flex; gap:14px; align-items:center; flex-wrap:wrap; background:#f8fafc;"
         th:attr="data-banner=${user.banner}">
        <div id="profileAvatar" style="font-size:32px;" th:text="${user.avatar != null ? user.avatar : 'ğŸ§‘'}">ğŸ§‘</div>
        <div>
            <div style="font-weight:700; font-size:18px;" th:text="${user.username}">user</div>
            <div style="color:#64748b; font-size:12px;">LV.<span th:text="${user.points / 50 + 1}">1</span> Â· <span th:text="${user.activeBadge != null ? user.activeBadge : 'ìë¼ë‚˜ëŠ” ìƒˆì‹¹'}"></span></div>
            <div style="display:flex; gap:8px; margin-top:4px; flex-wrap:wrap;">
                <div class="pill-soft">í¬ì¸íŠ¸: <span th:text="${user.points}">0</span></div>
                <div class="pill-soft">ì—°ì† í’€ì´: <span th:text="${user.streak}">0</span>ì¼</div>
            </div>
        </div>
        <a href="/profile/customize" class="btn btn-outline" style="margin-left:auto;">í”„ë¡œí•„ ê¾¸ë¯¸ê¸°</a>
        <div style="position:relative;">
            <button type="button" class="btn btn-outline" id="avatarDropdownToggle">ì•„ë°”íƒ€ ë³€ê²½</button>
            <div id="avatarDropdown" style="display:none; position:absolute; top:110%; left:0; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px; box-shadow:0 12px 20px rgba(0,0,0,0.15); min-width:180px;">
                <form th:action="@{/profile/customize/avatar}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <select name="avatar" style="width:100%; padding:8px 10px; border:1px solid #d1d5db; border-radius:10px;">
                        <option th:each="a : ${ownedAvatars}" th:value="${a}" th:text="${a}"></option>
                    </select>
                    <button class="btn" type="submit" style="margin-top:8px; width:100%;">ì¥ì°©</button>
                </form>
            </div>
        </div>
        <div style="position:relative;">
            <button type="button" class="btn btn-outline" id="bannerDropdownToggle">ë°°ë„ˆ ë³€ê²½</button>
            <div id="bannerDropdown" style="display:none; position:absolute; top:110%; left:0; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px; box-shadow:0 12px 20px rgba(0,0,0,0.15); min-width:180px;">
                <form th:action="@{/profile/customize/banner}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <select name="banner" style="width:100%; padding:8px 10px; border:1px solid #d1d5db; border-radius:10px;">
                        <option th:each="b : ${ownedBanners}" th:value="${b}" th:text="${b}"></option>
                    </select>
                    <button class="btn" type="submit" style="margin-top:8px; width:100%;">ì¥ì°©</button>
                </form>
            </div>
        </div>
        <div style="position:relative;">
            <button type="button" class="btn btn-outline" id="titleDropdownToggle">ì¹­í˜¸ ë³€ê²½</button>
            <div id="titleDropdown" style="display:none; position:absolute; top:110%; left:0; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px; box-shadow:0 12px 20px rgba(0,0,0,0.15); min-width:180px;">
                <form th:action="@{/shop/badge}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <select name="badgeId" style="width:100%; padding:8px 10px; border:1px solid #d1d5db; border-radius:10px;">
                        <option th:each="t : ${titleOptions}" th:value="${t}" th:text="${t}"></option>
                    </select>
                    <button class="btn" type="submit" style="margin-top:8px; width:100%;">ì ìš©</button>
                </form>
            </div>
        </div>
    </div>

    <div class="card" style="margin-top:12px;">
        <h3 style="margin:0 0 8px;">í•™ìŠµ í˜„í™©</h3>
        <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:10px;">
        <div class="pill-soft" style="background:#eef2ff;">ì˜¤ëŠ˜ í•™ìŠµ ì‹œê°„ <span id="studyTimeDisplay" th:text="${progressStats.todaySeconds() / 60} + 'm'">0m</span></div>
        <div class="pill-soft" style="background:#ecfccb;">ëª©í‘œ ë¬¸ì œ <input id="studyGoalInput" type="number" min="0" step="1" style="width:80px; margin:0 6px;" th:value="${user.dailyGoalMinutes}"> ê°œ</div>
        <div class="pill-soft" style="background:#e0f2fe;">ë‹¬ì„±ë¥  <span id="studyGoalProgress">0%</span></div>
        <div class="pill-soft" style="background:#fef3c7;">ì˜¤ëŠ˜ ë¬¸ì œ í’€ì´ <span id="todaySolvedCount" th:text="${progressStats.todaySolved()}">0</span>ê°œ</div>
        </div>
        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
            <button type="button" class="btn" id="startStudy">í•™ìŠµ ì‹œì‘</button>
            <button type="button" class="btn btn-outline" id="stopStudy">ì¼ì‹œì •ì§€</button>
            <button type="button" class="btn btn-outline" id="resetStudy">ì´ˆê¸°í™”</button>
        </div>
        <div style="margin-top:12px;">
            <div style="font-weight:700; margin-bottom:4px; display:flex; justify-content:space-between; align-items:center;">
                <button class="btn btn-outline" id="weekPrev" style="padding:4px 8px;">â†</button>
                <span id="weekLabel">ì´ë²ˆ ì£¼</span>
                <button class="btn btn-outline" id="weekNext" style="padding:4px 8px;">â†’</button>
            </div>
            <div class="week-wrapper">
                <div id="studyChart" class="week-grid"></div>
                <div class="week-labels">
                    <span>ì›”</span><span>í™”</span><span>ìˆ˜</span><span>ëª©</span><span>ê¸ˆ</span><span>í† </span><span>ì¼</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card" style="margin-top:12px;">
        <h3 style="margin:0 0 8px;">í’€ì´ íˆìŠ¤í† ë¦¬</h3>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
            <button class="btn btn-outline" id="monthPrev" style="padding:4px 8px;">â†</button>
            <span id="monthLabel" style="font-weight:700;">ì´ë²ˆ ë‹¬</span>
            <button class="btn btn-outline" id="monthNext" style="padding:4px 8px;">â†’</button>
        </div>
        <div class="week-wrapper heatmap-wrapper" style="margin-top:-6px;">
            <div class="week-labels" style="margin-bottom:6px;">
                <span>ì›”</span><span>í™”</span><span>ìˆ˜</span><span>ëª©</span><span>ê¸ˆ</span><span>í† </span><span>ì¼</span>
            </div>
            <div id="solveHeatmap" class="week-grid heatmap-grid"></div>
        </div>
    </div>

    <div class="card">
        <h3 style="margin:0 0 8px;">ì•ˆë‚´</h3>
        <p style="margin:0; color:#6b7280;">ì¹œêµ¬ ì¶”ê°€ì™€ ë¬¸ì œ ê³µìœ  ê¸°ëŠ¥ì€ ë” ì´ìƒ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
    </div>


</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const bannerEl = document.getElementById('profileBanner');
        if (bannerEl) {
            const banner = bannerEl.dataset.banner || '';
            if (banner === 'sunrise') bannerEl.style.background = 'linear-gradient(90deg,#f59e0b,#f97316)';
            else if (banner === 'ocean') bannerEl.style.background = 'linear-gradient(90deg,#06b6d4,#3b82f6)';
            else if (banner === 'forest') bannerEl.style.background = 'linear-gradient(90deg,#10b981,#065f46)';
            else if (banner === 'midnight') bannerEl.style.background = 'linear-gradient(90deg,#0f172a,#1e293b)';
            else if (banner === 'aurora') bannerEl.style.background = 'linear-gradient(90deg,#6366f1,#06b6d4,#22d3ee)';
            bannerEl.style.color = '#fff';
        }

        const bindDropdown = (toggleId, dropdownId) => {
            const btn = document.getElementById(toggleId);
            const box = document.getElementById(dropdownId);
            if (!btn || !box) return;
            btn.addEventListener('click', ()=>{
                box.style.display = box.style.display === 'block' ? 'none' : 'block';
            });
            document.addEventListener('click', (e)=>{
                if (!box.contains(e.target) && !btn.contains(e.target)) {
                    box.style.display = 'none';
                }
            });
        };
        bindDropdown('avatarDropdownToggle','avatarDropdown');
        bindDropdown('bannerDropdownToggle','bannerDropdown');
        bindDropdown('titleDropdownToggle','titleDropdown');

        // í•™ìŠµ íƒ€ì´ë¨¸/ëª©í‘œ
        const studyKey = 'studySessions';
        const goalKey = 'studyGoalMinutes';
        let timer = null;
        let startAt = null;
        const loadSessions = () => {
            try { return JSON.parse(localStorage.getItem(studyKey) || '[]'); } catch(e){ return []; }
        };
        const saveSessions = (list) => localStorage.setItem(studyKey, JSON.stringify(list));
        const todayKey = new Date().toISOString().slice(0,10);
        const startBtn = document.getElementById('startStudy');
        const stopBtn = document.getElementById('stopStudy');
        const resetBtn = document.getElementById('resetStudy');
        const goalInput = document.getElementById('studyGoalInput');
        const goalProgress = document.getElementById('studyGoalProgress');
        const timeDisplay = document.getElementById('studyTimeDisplay');
        const chart = document.getElementById('studyChart');

        const sessions = loadSessions();
        if (goalInput) {
            const savedGoal = parseInt(localStorage.getItem(goalKey) || '60', 10);
            goalInput.value = savedGoal;
        }

        let weekOffset = 0; // 0: current week, -1: previous week, etc.
        const weekLabel = document.getElementById('weekLabel');
        const renderChart = () => {
            if (!chart) return;
            chart.innerHTML = '';
            const start = new Date();
            const day = start.getDay();
            const diffToMonday = (day === 0 ? -6 : 1 - day) + (weekOffset * 7);
            start.setDate(start.getDate() + diffToMonday);
            const days = [];
            for (let i=0;i<7;i++){
                const d = new Date(start);
                d.setDate(start.getDate()+i);
                days.push(d.toISOString().slice(0,10));
            }
            if (weekLabel) {
                const month = start.getMonth()+1;
                const weekNum = Math.floor((start.getDate()-1)/7)+1;
                weekLabel.textContent = `${month}ì›” ${weekNum}ì£¼ì°¨`;
            }
            const maxSeconds = Math.max(1, ...days.map(day => sessions.filter(s=>s.date===day).reduce((a,b)=>a+b.seconds,0)));
            days.forEach(day=>{
                const sec = sessions.filter(s=>s.date===day).reduce((a,b)=>a+b.seconds,0);
                const bar = document.createElement('div');
                bar.style.height = `${(sec/maxSeconds)*100}%`;
                bar.style.background = '#60a5fa';
                bar.style.borderRadius = '8px';
                bar.title = `${day}: ${(sec/60).toFixed(1)}ë¶„`;
                chart.appendChild(bar);
            });
        };

        const renderToday = () => {
            const totalSec = sessions.filter(s=>s.date===todayKey).reduce((a,b)=>a+b.seconds,0);
            if (timeDisplay) timeDisplay.textContent = `${Math.round(totalSec/60)}m`;
        };

        goalInput?.addEventListener('change', ()=>{
            localStorage.setItem(goalKey, goalInput.value || '0');
            fetch('/api/study/goal', {
                method:'POST',
                headers:{'Content-Type':'application/x-www-form-urlencoded'},
                body: new URLSearchParams({minutes: goalInput.value || '0'})
            }).catch(()=>{});
            renderSolveChart();
        });

        startBtn?.addEventListener('click', ()=>{
            if (timer) return;
            startAt = Date.now();
            timer = setInterval(()=>{
                const diff = Math.floor((Date.now() - startAt)/1000);
                if (timeDisplay) timeDisplay.textContent = `${Math.round(diff/60)}m`;
            }, 1000);
        });

        const stopTimer = () => {
            if (!timer) return;
            clearInterval(timer);
            timer = null;
            const diff = Math.max(0, Math.floor((Date.now() - startAt)/1000));
            sessions.push({date: todayKey, seconds: diff});
            saveSessions(sessions);
            fetch('/api/study/log', {
                method:'POST',
                headers:{'Content-Type':'application/x-www-form-urlencoded'},
                body: new URLSearchParams({seconds: String(diff)})
            }).catch(()=>{});
            renderToday();
            renderChart();
            renderSolveChart();
        };

        stopBtn?.addEventListener('click', stopTimer);
        resetBtn?.addEventListener('click', ()=>{
            localStorage.removeItem(studyKey);
            sessions.splice(0, sessions.length);
            renderToday();
            renderChart();
            renderSolveChart();
        });

        // ë¬¸ì œ í’€ì´(ìµœê·¼ 7ì¼) ê·¸ë˜í”„ - solveDates ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©
        const renderSolveChart = () => {
            const raw = localStorage.getItem('solveDates') || '[]';
            let dates = [];
            try { dates = JSON.parse(raw); } catch(e){}
            const now = new Date(displayMonth.getFullYear(), displayMonth.getMonth(), 1);
            const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
            if (monthLabel) {
                monthLabel.textContent = `${now.getFullYear()}ë…„ ${now.getMonth()+1}ì›”`;
            }
            if (heatmap) {
                heatmap.innerHTML = '';
                for (let d=1; d<=31; d++){
                    const cell = document.createElement('div');
                    cell.style.border = '1px solid #e5e7eb';
                    cell.style.borderRadius = '6px';
                    cell.style.padding = '10px 0';
                    if (d <= daysInMonth) {
                        const key = new Date(now.getFullYear(), now.getMonth(), d).toISOString().slice(0,10);
                        const active = dates.includes(key);
                        cell.style.background = active ? '#a7f3d0' : '#f8fafc';
                        cell.textContent = d;
                    } else {
                        cell.style.background = '#f8fafc';
                    }
                    heatmap.appendChild(cell);
                }
            }
            const goal = parseInt(goalInput?.value || '0', 10);
            const todayKey = new Date().toISOString().slice(0,10);
            const todayCount = dates.filter(x=>x===todayKey).length;
            const pct = goal > 0 ? Math.min(100, Math.round(todayCount / goal * 100)) : 0;
            if (goalProgress) goalProgress.textContent = `${pct}%`;
            const todayCountEl = document.getElementById('todaySolvedCount');
            if (todayCountEl) todayCountEl.textContent = todayCount;
        };

        // íˆíŠ¸ë§µ
        const heatmap = document.getElementById('solveHeatmap');
        const monthLabel = document.getElementById('monthLabel');
        let displayMonth = new Date();

        renderToday();
        renderChart();
        renderSolveChart();

        document.getElementById('weekPrev')?.addEventListener('click', ()=>{ weekOffset -= 1; renderChart(); });
        document.getElementById('weekNext')?.addEventListener('click', ()=>{ weekOffset += 1; renderChart(); });
        document.getElementById('monthPrev')?.addEventListener('click', ()=>{ displayMonth.setMonth(displayMonth.getMonth()-1); renderSolveChart(); });
        document.getElementById('monthNext')?.addEventListener('click', ()=>{ displayMonth.setMonth(displayMonth.getMonth()+1); renderSolveChart(); });
    });
</script>
</body>
</html>
